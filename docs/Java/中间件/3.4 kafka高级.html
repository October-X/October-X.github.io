<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Java/中间件/3.4 kafka高级">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">3.4 kafka高级 | SUITABLE</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://october-x.github.io/docs/Java/中间件/3.4 kafka高级"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="keywords" content="frontend, react, javascript, css, react, vue, typescript, docusaurus, blog, personal blog, personal website,html"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="3.4 kafka高级 | SUITABLE"><meta data-rh="true" name="description" content="面试，作为架构师 有深度的问题。"><meta data-rh="true" property="og:description" content="面试，作为架构师 有深度的问题。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://october-x.github.io/docs/Java/中间件/3.4 kafka高级"><link data-rh="true" rel="alternate" href="https://october-x.github.io/docs/Java/中间件/3.4 kafka高级" hreflang="zh"><link data-rh="true" rel="alternate" href="https://october-x.github.io/docs/Java/中间件/3.4 kafka高级" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://8YE83IQFLA-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="SUITABLE RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="SUITABLE Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="SUITABLE" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.12e922a4.css">
<link rel="preload" href="/assets/js/runtime~main.730de416.js" as="script">
<link rel="preload" href="/assets/js/main.887d1c07.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">SUITABLE</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/docs/Interview">Study</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Skill</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/html">HTML</a></li><li><a class="dropdown__link" href="/docs/css">CSS</a></li><li><a class="dropdown__link" href="/docs/js">JavaScript</a></li><li><a class="dropdown__link" href="/docs/vue">Vue</a></li><li><a class="dropdown__link" href="/docs/vue3">Vue3</a></li><li><a class="dropdown__link" href="/docs/ts">TypeSript</a></li><li><a class="dropdown__link" href="/docs/react">React</a></li><li><a class="dropdown__link" href="/docs/nodejs">NodeJS</a></li><li><a class="dropdown__link" href="/docs/webpack">WebPack</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Java">Java</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><b>SUITABLE</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/docs/Java">Java</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/JavaSE/计算机基础和java环境搭建">JavaSE</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java">目录</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/其他/GIT入门">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/mysql学习/mysql入门">mysql学习</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/web/CSS">web</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/基础知识/日志框架">基础知识</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/框架/MyBatis">框架</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Java/中间件/nginx">中间件</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/中间件/nginx">1.nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/中间件/2.1 ELK入门">2.1 ELK入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/中间件/2.2 ELK进阶">2.2 ELK进阶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/中间件/3.1 RabbitMQ入门">3.1 RabbitMQ入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/中间件/3.2 RocketMQ基础篇">3.2 RocketMQ基础篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/中间件/3.3 Kafka入门">3.3 Kafka入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Java/中间件/3.4 kafka高级">3.4 kafka高级</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/框架扩展/SpringCloud">框架扩展</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/Docker">9. Docker</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/项目/短信调度">项目</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/数据结构与算法-基础">11. 数据结构与算法-基础</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">中间件</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">3.4 kafka高级</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>3.4 kafka高级</h1><p>面试，作为架构师 有深度的问题。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第一章-分区和副本机制">第一章 分区和副本机制<a href="#第一章-分区和副本机制" class="hash-link" aria-label="第一章 分区和副本机制的直接链接" title="第一章 分区和副本机制的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一生产者分区写入策略">一、<strong>生产者分区写入策略</strong><a href="#一生产者分区写入策略" class="hash-link" aria-label="一生产者分区写入策略的直接链接" title="一生产者分区写入策略的直接链接">​</a></h3><p>生产者写入消息到topic，Kafka将依据不同的策略将数据分配到不同的分区中</p><ol><li>轮询分区策略</li><li>随机分区策略</li><li>按key分区分配策略</li><li>自定义分区策略</li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-轮询策略">1、 轮询策略<a href="#1-轮询策略" class="hash-link" aria-label="1、 轮询策略的直接链接" title="1、 轮询策略的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218211147862-04ae8b52.png" alt="image-20221218211147862" class="img_ev3q">image-20221218211147862</p><p>默认的策略，也是使用最多的策略，可以最大限度保证所有消息平均分配到一个分区</p><p>如果在生产消息时，key为null，则使用轮询算法均衡地分配分区</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-随机策略不用">2、 随机策略（不用）<a href="#2-随机策略不用" class="hash-link" aria-label="2、 随机策略（不用）的直接链接" title="2、 随机策略（不用）的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218211240293-95aaa1c7.png" alt="image-20221218211240293" class="img_ev3q">image-20221218211240293</p><p>随机策略，每次都随机地将消息分配到每个分区。在较早的版本，默认的分区策略就是随机策略，也是为了将消息均衡地写入到每个分区。但后续轮询策略表现更佳，所以基本上很少会使用随机策略。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3按key分配策略">3、<strong>按key分配策略</strong><a href="#3按key分配策略" class="hash-link" aria-label="3按key分配策略的直接链接" title="3按key分配策略的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218211822544-982cc5c0.png" alt="image-20221218211822544" class="img_ev3q">image-20221218211822544</p><p>按key分配策略，有可能会出现「数据倾斜」，例如：某个key包含了大量的数据，因为key值一样，所有所有的数据将都分配到一个分区中，造成该分区的消息数量远大于其他的分区。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4乱序问题">4、<strong>乱序问题</strong><a href="#4乱序问题" class="hash-link" aria-label="4乱序问题的直接链接" title="4乱序问题的直接链接">​</a></h4><p>轮询策略、随机策略都会导致一个问题，生产到Kafka中的数据是乱序存储的。而按key分区可以一定程度上实现数据有序存储——也就是局部有序，但这又可能会导致数据倾斜，所以在实际生产环境中要结合实际情况来做取舍。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218212046236-8c12fe52.png" alt="image-20221218212046236" class="img_ev3q">image-20221218212046236</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5自定义分区策略">5、<strong>自定义分区策略</strong><a href="#5自定义分区策略" class="hash-link" aria-label="5自定义分区策略的直接链接" title="5自定义分区策略的直接链接">​</a></h4><p>实现步骤：</p><ol><li>创建自定义分区器</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214)">com</span><span class="token namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token namespace" style="color:rgb(178, 204, 214)">ydlclass</span><span class="token namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token namespace" style="color:rgb(178, 204, 214)">day2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">org</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">apache</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">kafka</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">clients</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">producer</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Partitioner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">org</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">apache</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">kafka</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">common</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Cluster</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">java</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">util</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Map</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">java</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">util</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Random</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">/**</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> * @Created by IT李老师</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> * 公主号 “元动力课堂”</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> * 个人微 itlils</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">KeyWithRandomPartitioner</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">implements</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Partitioner</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">private</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Random</span><span class="token plain"> random</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//分区逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">partition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> topic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Object</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">byte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> keyBytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Object</span><span class="token plain"> value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">byte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> valueBytes</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Cluster</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> random</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">nextInt</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token class-name" style="color:rgb(255, 203, 139)">Integer</span><span class="token plain"> count </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> cluster</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">partitionCountForTopic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">topic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//某个topic的分区数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> parNum</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">i</span><span class="token operator" style="color:rgb(127, 219, 202)">%</span><span class="token plain">count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">return</span><span class="token plain"> parNum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">close</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//这个类初始化的时候做的事儿</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token annotation punctuation" style="color:rgb(199, 146, 234)">@Override</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">configure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Map</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token generics"> </span><span class="token generics operator" style="color:rgb(127, 219, 202)">?</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> configs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        random</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Random</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>在Kafka生产者配置中，自定使用自定义分区器的类名</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">ProducerConfig</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token constant" style="color:rgb(130, 170, 255)">PARTITIONER_CLASS_CONFIG</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">KeyWithRandomPartitioner</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token keyword" style="color:rgb(127, 219, 202)">class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">getName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二-消费者组rebalance机制">二、 消费者组Rebalance机制<a href="#二-消费者组rebalance机制" class="hash-link" aria-label="二、 消费者组Rebalance机制的直接链接" title="二、 消费者组Rebalance机制的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1rebalance再均衡">1、<strong>Rebalance再均衡</strong><a href="#1rebalance再均衡" class="hash-link" aria-label="1rebalance再均衡的直接链接" title="1rebalance再均衡的直接链接">​</a></h4><p>Kafka中的Rebalance称之为再均衡，是Kafka中确保Consumer group下所有的consumer如何达成一致，分配订阅的topic的每个分区的机制。</p><p>Rebalance触发的时机有：</p><ol><li>消费者组中consumer的个数发生变化。例如：有新的consumer加入到消费者组，或者是某个consumer停止了。</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218220516546-d3af7015.png" alt="image-20221218220516546" class="img_ev3q">image-20221218220516546</p><ol><li>订阅的topic个数发生变化</li></ol><p>消费者可以订阅多个主题，假设当前的消费者组订阅了三个主题，但有一个主题突然被删除了，此时也需要发生再均衡。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218220745917-d80f2199.png" alt="image-20221218220745917" class="img_ev3q">image-20221218220745917</p><ol><li>订阅的topic分区数发生变化</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218220906025-e35af2b6.png" alt="image-20221218220906025" class="img_ev3q">image-20221218220906025</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2rebalance的不良影响">2、Rebalance的不良影响<a href="#2rebalance的不良影响" class="hash-link" aria-label="2、Rebalance的不良影响的直接链接" title="2、Rebalance的不良影响的直接链接">​</a></h4><ul><li>发生Rebalance时，consumer group下的所有consumer都会协调在一起共同参与，Kafka使用分配策略尽可能达到最公平的分配</li><li>Rebalance过程会对consumer group产生非常严重的影响，Rebalance的过程中所有的消费者都将停止工作，直到Rebalance完成</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三消费者分区分配策略">三、<strong>消费者分区分配策略</strong><a href="#三消费者分区分配策略" class="hash-link" aria-label="三消费者分区分配策略的直接链接" title="三消费者分区分配策略的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-range范围分配策略">1、 <strong>Range范围分配策略</strong><a href="#1-range范围分配策略" class="hash-link" aria-label="1-range范围分配策略的直接链接" title="1-range范围分配策略的直接链接">​</a></h4><p>Range范围分配策略是Kafka默认的分配策略，它可以确保每个消费者消费的分区数量是均衡的。</p><p>注意：Rangle范围分配策略是针对每个Topic的。</p><p><strong>配置</strong></p><p>配置消费者的partition.assignment.strategy为</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">org.apache.kafka.clients.consumer.RangeAssignor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>算法公式</strong></p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">n = 分区数量 / 消费者数量</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">m = 分区数量 % 消费者数量</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">前m个消费者消费n+1个</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">剩余消费者消费n个</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218224135612-b20e9dc3.png" alt="image-20221218224135612" class="img_ev3q">image-20221218224135612</p><p>作业：画图 7个分区，同一消费者组4个消费者，消费情况？</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2roundrobin轮询策略">2、<strong>RoundRobin轮询策略</strong><a href="#2roundrobin轮询策略" class="hash-link" aria-label="2roundrobin轮询策略的直接链接" title="2roundrobin轮询策略的直接链接">​</a></h4><p>RoundRobinAssignor轮询策略是将消费组内所有消费者以及消费者所订阅的所有topic的partition按照字典序排序（topic和分区的hashcode进行排序），然后通过轮询方式逐个将分区以此分配给每个消费者。</p><p>*<strong>*配置<!-- -->*<!-- -->*</strong></p><p>配置消费者的partition.assignment.strategy为</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">org.apache.kafka.clients.consumer.RoundRobinAssignor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218224751014-7ec45bf5.png" alt="image-20221218224751014" class="img_ev3q">image-20221218224751014</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3stricky粘性分配策略">3、<strong>Stricky粘性分配策略</strong><a href="#3stricky粘性分配策略" class="hash-link" aria-label="3stricky粘性分配策略的直接链接" title="3stricky粘性分配策略的直接链接">​</a></h4><p>从Kafka 0.11.x开始，引入此类分配策略。主要目的：</p><ol><li>分区分配尽可能均匀</li><li>在发生rebalance的时候，分区的分配尽可能与上一次分配保持相同</li></ol><p>没有发生rebalance时，Striky粘性分配策略和RoundRobin分配策略类似。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218225249755-fbdf01ea.png" alt="image-20221218225249755" class="img_ev3q">image-20221218225249755</p><p>上面如果consumer2崩溃了，此时需要进行rebalance。如果是Range分配和轮询分配都会重新进行分配，例如：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218225206460-7426052d.png" alt="image-20221218225206460" class="img_ev3q">image-20221218225206460</p><p>通过上图，我们发现，consumer0和consumer1原来消费的分区大多发生了改变。接下来我们再来看下粘性分配策略。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218225331550-daf46b1e.png" alt="image-20221218225331550" class="img_ev3q">image-20221218225331550</p><p>我们发现，Striky粘性分配策略，保留rebalance之前的分配结果。这样，只是将原先consumer2负责的两个分区再均匀分配给consumer0、consumer1。这样可以明显减少系统资源的浪费，例如：之前consumer0、consumer1之前正在消费某几个分区，但由于rebalance发生，导致consumer0、consumer1需要重新消费之前正在处理的分区，导致不必要的系统开销。（例如：某个事务正在进行就必须要取消了）</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四副本机制">四、<strong>副本机制</strong><a href="#四副本机制" class="hash-link" aria-label="四副本机制的直接链接" title="四副本机制的直接链接">​</a></h3><p>副本的目的就是冗余备份，当某个Broker上的分区数据丢失时，依然可以保障数据可用。因为在其他的Broker上的副本是可用的。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-producer的acks参数">1、 <strong>producer的ACKs参数</strong><a href="#1-producer的acks参数" class="hash-link" aria-label="1-producer的acks参数的直接链接" title="1-producer的acks参数的直接链接">​</a></h4><p>对副本关系较大的就是，producer配置的acks参数了,acks参数表示当生产者生产消息的时候，写入到副本的要求严格程度。它决定了生产者如何在性能和可靠性之间做取舍。</p><p>配置：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token class-name" style="color:rgb(255, 203, 139)">Properties</span><span class="token plain"> props </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bootstrap.servers&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;node1.ydlclass.com:9092&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;acks&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;all&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;key.serializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">props</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;value.serializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2acks配置为0">2、<strong>acks配置为0</strong><a href="#2acks配置为0" class="hash-link" aria-label="2acks配置为0的直接链接" title="2acks配置为0的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218231532548-12b24475.png" alt="image-20221218231532548" class="img_ev3q">image-20221218231532548</p><p>ACK为0，基准测试：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-producer-perf-test.sh --topic benchmark --num-records 5000000 --throughput -1 --record-size 1000 --producer-props bootstrap.servers=node1.ydlclass.com:9092,node2.ydlclass.com:9092,node3.ydlclass.com:9092 acks=0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>测试结果：</p><table><thead><tr><th>指标</th><th>单分区单副本（ack=0）</th><th>单分区单副本(ack=1)</th></tr></thead><tbody><tr><td>吞吐量</td><td>每秒16.5W条记录</td><td>每秒9.3W条记录</td></tr><tr><td>吞吐速率</td><td>158.19 MB/sec每秒约160MB数据</td><td>88.78 MB/sec每秒约89MB数据</td></tr><tr><td>平均延迟时间</td><td>192.43 ms avg latency</td><td>346.62 ms avg latency</td></tr><tr><td>最大延迟时间</td><td>670.00 ms max latency</td><td>1003.00 ms max latency</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-acks配置为1">3、 <strong>acks配置为1</strong><a href="#3-acks配置为1" class="hash-link" aria-label="3-acks配置为1的直接链接" title="3-acks配置为1的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218231720722-a67a32f7.png" alt="image-20221218231720722" class="img_ev3q">image-20221218231720722</p><p>当生产者的ACK配置为1时，生产者会等待leader副本确认接收后，才会发送下一条数据，性能中等。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-acks配置为-1或者all">4、 <strong>acks配置为-1或者all</strong><a href="#4-acks配置为-1或者all" class="hash-link" aria-label="4-acks配置为-1或者all的直接链接" title="4-acks配置为-1或者all的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221218231818296-397abfe8.png" alt="image-20221218231818296" class="img_ev3q">image-20221218231818296</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-producer-perf-test.sh --topic benchmark --num-records 5000000 --throughput -1 --record-size 1000 --producer-props bootstrap.servers=node1.ydlclass.com:9092,node2.ydlclass.com:9092,node3.ydlclass.com:9092 acks=all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th>指标</th><th>单分区单副本（ack=0）</th><th>单分区单副本(ack=1)</th><th>单分区单副本(ack=-1/all)</th></tr></thead><tbody><tr><td>吞吐量</td><td>每秒16.5W条记录</td><td>每秒9.3W条记录</td><td>每秒7.3W调记录</td></tr><tr><td>吞吐速率</td><td>158.19 MB/sec</td><td>88.78 MB/sec</td><td>70.18 MB</td></tr><tr><td>平均延迟时间</td><td>192.43 ms</td><td>346.62 ms</td><td>438.77 ms</td></tr><tr><td>最大延迟时间</td><td>670.00 ms</td><td>1003.00 ms</td><td>1884.00 ms</td></tr></tbody></table><p>作业：测试本地虚拟机，</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第二章-高级high-levelapi与低级low-levelapi">第二章 高级（High Level）API与低级（Low Level）API<a href="#第二章-高级high-levelapi与低级low-levelapi" class="hash-link" aria-label="第二章 高级（High Level）API与低级（Low Level）API的直接链接" title="第二章 高级（High Level）API与低级（Low Level）API的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一-高级api">一、 <strong>高级API</strong><a href="#一-高级api" class="hash-link" aria-label="一-高级api的直接链接" title="一-高级api的直接链接">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">package</span><span class="token plain"> </span><span class="token namespace" style="color:rgb(178, 204, 214)">com</span><span class="token namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token namespace" style="color:rgb(178, 204, 214)">ydlclass</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">org</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">apache</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">kafka</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">clients</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">consumer</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">ConsumerRecord</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">org</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">apache</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">kafka</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">clients</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">consumer</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">ConsumerRecords</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">org</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">apache</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">kafka</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">clients</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">consumer</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">KafkaConsumer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">java</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">time</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Duration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">java</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">util</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Collections</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">import</span><span class="token plain"> </span><span class="token import namespace" style="color:rgb(178, 204, 214)">java</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import namespace" style="color:rgb(178, 204, 214)">util</span><span class="token import namespace punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token import class-name" style="color:rgb(255, 203, 139)">Properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">/**</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> * @Created by IT李老师</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> * 公主号 “元动力课堂”</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> * 个人微 itlils</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">KafkaConsumerTest</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">public</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">static</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">main</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> args</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">throws</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">ClassNotFoundException</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//1配置告诉程序kafka在哪里</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token class-name" style="color:rgb(255, 203, 139)">Properties</span><span class="token plain"> properties</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;bootstrap.servers&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;node1.ydlclass.com:9092&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//broker地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;group.id&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;test3&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//消费者组   特性：同组争抢消息，不同组消费相同的消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;enable.auto.commit&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;true&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//自动回复</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;auto.commit.interval.ms&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;1000&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//每秒告诉mq，收到了多少条消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//设置key反序列化器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;key.deserializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">forName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//设置值反序列化器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">put</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;value.deserializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">Class</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">forName</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//2创建连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token class-name" style="color:rgb(255, 203, 139)">KafkaConsumer</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> consumer </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">KafkaConsumer</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">properties</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//3订阅消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        consumer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">subscribe</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Collections</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">singletonList</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;itlils2&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token keyword" style="color:rgb(127, 219, 202)">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token class-name" style="color:rgb(255, 203, 139)">ConsumerRecords</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> consumerRecords </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> consumer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">poll</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Duration</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">ofSeconds</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token keyword" style="color:rgb(127, 219, 202)">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">ConsumerRecord</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&lt;</span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token generics"> </span><span class="token generics class-name" style="color:rgb(255, 203, 139)">String</span><span class="token generics punctuation" style="color:rgb(199, 146, 234)">&gt;</span><span class="token plain"> consumerRecord </span><span class="token operator" style="color:rgb(127, 219, 202)">:</span><span class="token plain"> consumerRecords</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token class-name" style="color:rgb(255, 203, 139)">System</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">out</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">println</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;topic:&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain">consumerRecord</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">topic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;|offset:&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain">consumerRecord</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">offset</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                        </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;|key&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain">consumerRecord</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;|value&quot;</span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain">consumerRecord</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">                </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//做响应的业务逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">        </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">//4千万别关连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上面是之前编写的代码，消费Kafka的消息很容易实现，写起来比较简单</p><p>不需要执行去管理offset，直接通过ZK管理；也不需要管理分区、副本，由Kafka统一管理</p><p>消费者会自动根据上一次在ZK中保存的offset去接着获取数据</p><p>在ZK中，不同的消费者组（group）同一个topic记录不同的offset，这样不同程序读取同一个topic，不会受offset的影响</p><p>*<strong>*高级API的缺点<!-- -->*<!-- -->*</strong></p><p>不能控制offset，例如：想从指定的位置读取</p><p>不能细化控制分区、副本、ZK等</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二低级api">二、<strong>低级API</strong><a href="#二低级api" class="hash-link" aria-label="二低级api的直接链接" title="二低级api的直接链接">​</a></h3><p>通过使用低级API，我们可以自己来控制offset，想从哪儿读，就可以从哪儿读。而且，可以自己控制连接分区，对分区自定义负载均衡。而且，之前offset是自动保存在ZK中，使用低级API，我们可以将offset不一定要使用ZK存储，我们可以自己来存储offset。例如：存储在文件、MySQL、或者内存中。但是低级API，比较复杂，需要执行控制offset，连接到哪个分区，并找到分区的leader。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三-手动消费分区数据">三、 <strong>手动消费分区数据</strong><a href="#三-手动消费分区数据" class="hash-link" aria-label="三-手动消费分区数据的直接链接" title="三-手动消费分区数据的直接链接">​</a></h3><p>之前的代码，我们让Kafka根据消费组中的消费者动态地为topic分配要消费的分区。但在某些时候，我们需要指定要消费的分区，例如：</p><p>如果某个程序将某个指定分区的数据保存到外部存储中，例如：Redis、MySQL，那么保存数据的时候，只需要消费该指定的分区数据即可</p><p>如果某个程序是高可用的，在程序出现故障时将自动重启(例如：后面我们将学习的Flink、Spark程序)。这种情况下，程序将从指定的分区重新开始消费数据。</p><p>如何进行手动消费分区中的数据呢？</p><ol><li>不再使用之前的 subscribe 方法订阅主题，而使用 「assign」方法指定想要消费的消息</li></ol><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 139)">String</span><span class="token plain"> topic</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token string" style="color:rgb(173, 219, 103)">&quot;itlils&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 139)">TopicPartition</span><span class="token plain"> partition0 </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">TopicPartition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">topic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token class-name" style="color:rgb(255, 203, 139)">TopicPartition</span><span class="token plain"> partition1 </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token keyword" style="color:rgb(127, 219, 202)">new</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 139)">TopicPartition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">topic</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  consumer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">assign</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 139)">Arrays</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">asList</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">partition0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> partition1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>一旦指定了分区，就可以就像前面的示例一样，在循环中调用「poll」方法消费消息</li></ol><p>注意</p><ol><li>当手动管理消费分区时，即使GroupID是一样的，Kafka的组协调器都将不再起作用</li><li>如果消费者失败，也将不再自动进行分区重新分配</li></ol><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第三章-监控工具kafka-eagle介绍">第三章 监控工具Kafka-eagle介绍<a href="#第三章-监控工具kafka-eagle介绍" class="hash-link" aria-label="第三章 监控工具Kafka-eagle介绍的直接链接" title="第三章 监控工具Kafka-eagle介绍的直接链接">​</a></h2><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219001503986-08f2e237.png" alt="image-20221219001503986" class="img_ev3q">image-20221219001503986</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一-kafka-eagle简介">一、 <strong>Kafka-Eagle简介</strong><a href="#一-kafka-eagle简介" class="hash-link" aria-label="一-kafka-eagle简介的直接链接" title="一-kafka-eagle简介的直接链接">​</a></h3><p>在开发工作中，当业务前提不复杂时，可以使用Kafka命令来进行一些集群的管理工作。但如果业务变得复杂，例如：我们需要增加group、topic分区，此时，我们再使用命令行就感觉很不方便，此时，如果使用一个可视化的工具帮助我们完成日常的管理工作，将会大大提高对于Kafka集群管理的效率，而且我们使用工具来监控消费者在Kafka中消费情况。</p><p>早期，要监控Kafka集群我们可以使用Kafka Monitor以及Kafka Manager，但随着我们对监控的功能要求、性能要求的提高，这些工具已经无法满足。</p><p>Kafka Eagle是一款结合了目前大数据Kafka监控工具的特点，重新研发的一块开源免费的Kafka集群优秀的监控工具。它可以非常方便的监控生产环境中的offset、lag变化、partition分布、owner等。</p><p>官网地址：<a href="https://www.kafka-eagle.org/" target="_blank" rel="noopener noreferrer">https://www.kafka-eagle.org/open in new window</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二-安装kafka-eagle">二、 <strong>安装Kafka-Eagle</strong><a href="#二-安装kafka-eagle" class="hash-link" aria-label="二-安装kafka-eagle的直接链接" title="二-安装kafka-eagle的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-开启kafka-jmx端口">1、 <strong>开启Kafka JMX端口</strong><a href="#1-开启kafka-jmx端口" class="hash-link" aria-label="1-开启kafka-jmx端口的直接链接" title="1-开启kafka-jmx端口的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-jmx接口">（1） <strong>JMX接口</strong><a href="#1-jmx接口" class="hash-link" aria-label="1-jmx接口的直接链接" title="1-jmx接口的直接链接">​</a></h5><p>JMX(Java Management Extensions)是一个为应用程序植入管理功能的框架。JMX是一套标准的代理和服务，实际上，用户可以在任何Java应用程序中使用这些代理和服务实现管理。很多的一些软件都提供了JMX接口，来实现一些管理、监控功能。</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-开启kafka-jmx">（2） <strong>开启Kafka JMX</strong><a href="#2-开启kafka-jmx" class="hash-link" aria-label="2-开启kafka-jmx的直接链接" title="2-开启kafka-jmx的直接链接">​</a></h5><p>在启动Kafka的脚本前，添加：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">cd ${KAFKA_HOME}export JMX_PORT=9988 nohup bin/kafka-server-start.sh config/server.properties &amp;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2安装kafka-eagle">2、<strong>安装Kafka-Eagle</strong><a href="#2安装kafka-eagle" class="hash-link" aria-label="2安装kafka-eagle的直接链接" title="2安装kafka-eagle的直接链接">​</a></h4><p>0配置java环境变量</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">vi /etc/profile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">export JAVA_HOME=/usr/java/jdk1.8.0_351-amd64</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">export PATH=$PATH:$JAVA_HOME/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>1.上传tar包到/export/software</p><p>2.解压</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">tar -zxvf efak-xxx-bin.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3.改名</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">mv efak-web-3.0.2 efak</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4.设置efak环境变量</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">vi /etc/profile</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">export KE_HOME=/export/software/efak</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">export PATH=$PATH:$KE_HOME/bin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">source /etc/profile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5.修改配置文件</p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">cd ${KE_HOME}/conf</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">vi system-config.properties</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># multi zookeeper &amp; kafka cluster list</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># Settings prefixed with &#x27;kafka.eagle.&#x27; will be deprecated, use &#x27;efak.&#x27; instead</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.zk.cluster.alias=cluster1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.zk.list=node1.ydlclass.com:2181,node2.ydlclass.com:2181,node3.ydlclass.com:2181</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#cluster2.zk.list=xdn10:2181,xdn11:2181,xdn12:2181</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># zookeeper enable acl</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.zk.acl.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.zk.acl.schema=digest</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.zk.acl.username=test</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.zk.acl.password=test123</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># broker size online list</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.broker.size=20</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># zk client thread limit</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">kafka.zk.limit.size=16</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># EFAK webui port</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.webui.port=8048</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># EFAK enable distributed</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.distributed.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.cluster.mode.status=master</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.worknode.master.host=localhost</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.worknode.port=8085</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka jmx acl and ssl authenticate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.acl=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.user=keadmin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.password=keadmin123</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.ssl=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.truststore.location=/data/ssl/certificates/kafka.truststore</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.truststore.password=ke123456</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka offset storage</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.offset.storage=kafka</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.offset.storage=zk</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka jmx uri</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.jmx.uri=service:jmx:rmi:///jndi/rmi://%s/jmxrmi</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka metrics, 15 days by default</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.metrics.charts=true</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.metrics.retain=15</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka sql topic records max</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.sql.topic.records.max=5000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.sql.topic.preview.records.max=10</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># delete kafka topic token</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.topic.token=keadmin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka sasl authenticate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.protocol=SASL_PLAINTEXT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.mechanism=SCRAM-SHA-256</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=&quot;kafka&quot; password=&quot;kafka-eagle&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.client.id=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.blacklist.topics=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.cgroup.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster1.efak.sasl.cgroup.topics=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.protocol=SASL_PLAINTEXT</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.mechanism=PLAIN</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username=&quot;kafka&quot; password=&quot;kafka-eagle&quot;;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.client.id=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.blacklist.topics=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.cgroup.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster2.efak.sasl.cgroup.topics=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka ssl authenticate</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.protocol=SSL</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.truststore.location=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.truststore.password=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.keystore.location=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.keystore.password=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.key.password=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.endpoint.identification.algorithm=https</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.blacklist.topics=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.cgroup.enable=false</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cluster3.efak.ssl.cgroup.topics=</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka sqlite jdbc driver address</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#efak.driver=org.sqlite.JDBC</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#efak.url=jdbc:sqlite:/hadoop/kafka-eagle/db/ke.db</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#efak.username=root</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">#efak.password=www.kafka-eagle.org</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># kafka mysql jdbc driver address</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">######################################</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.driver=com.mysql.cj.jdbc.Driver</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.url=jdbc:mysql://127.0.0.1:3306/ke?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.username=root</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">efak.password=admin2022_</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6.单机启动</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">cd ${KE_HOME}/bin</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">chmod +x ke.sh</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">ke.sh start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>7.访问</p><p><a href="http://192.168.246.128:8048/" target="_blank" rel="noopener noreferrer">http://192.168.246.128:8048/open in new window</a></p><p>admin 123456</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219014611506-eb08ce40.png" alt="image-20221219014611506" class="img_ev3q">image-20221219014611506</p><p>8.无需配置</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219014729785-fb88f015.png" alt="image-20221219014729785" class="img_ev3q">image-20221219014729785</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三-kafka度量指标">三、 <strong>Kafka度量指标</strong><a href="#三-kafka度量指标" class="hash-link" aria-label="三-kafka度量指标的直接链接" title="三-kafka度量指标的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-topic-list">1、 <strong>topic list</strong><a href="#1-topic-list" class="hash-link" aria-label="1-topic-list的直接链接" title="1-topic-list的直接链接">​</a></h4><p>点击Topic下的List菜单，就可以展示当前Kafka集群中的所有topic。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219014812642-30448029.png" alt="image-20221219014812642" class="img_ev3q">image-20221219014812642</p><table><thead><tr><th>指标</th><th>意义</th></tr></thead><tbody><tr><td>Brokers Spread</td><td>broker使用率</td></tr><tr><td>Brokers Skew</td><td>分区是否倾斜</td></tr><tr><td>Brokers Leader Skew</td><td>leader partition是否存在倾斜</td></tr></tbody></table><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-消费者者消息总计">2、 <strong>消费者者消息总计</strong><a href="#2-消费者者消息总计" class="hash-link" aria-label="2-消费者者消息总计的直接链接" title="2-消费者者消息总计的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219014838349-2baf1951.png" alt="image-20221219014838349" class="img_ev3q">image-20221219014838349</p><p>broker信息</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219014855158-96a18ef5.png" alt="image-20221219014855158" class="img_ev3q">image-20221219014855158</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第四章-kafka原理">第四章 Kafka原理<a href="#第四章-kafka原理" class="hash-link" aria-label="第四章 Kafka原理的直接链接" title="第四章 Kafka原理的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一分区的leader与follower">一、<strong>分区的leader与follower</strong><a href="#一分区的leader与follower" class="hash-link" aria-label="一分区的leader与follower的直接链接" title="一分区的leader与follower的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-leader和follower">1、 <strong>Leader和Follower</strong><a href="#1-leader和follower" class="hash-link" aria-label="1-leader和follower的直接链接" title="1-leader和follower的直接链接">​</a></h4><p>在Kafka中，每个topic都可以配置多个分区以及多个副本。每个分区都有一个leader以及0个或者多个follower，在创建topic时，Kafka会将每个分区的leader均匀地分配在每个broker上。我们正常使用kafka是感觉不到leader、follower的存在的。但其实，所有的读写操作都是由leader处理，而所有的follower都复制leader的<strong>日志数据文件</strong>，如果leader出现故障时，follower就会被选举为leader。所以，可以这样说：</p><ul><li>Kafka中的leader负责处理读写操作，而follower只负责副本数据的同步</li><li>如果leader出现故障，其他follower会被重新选举为leader</li><li>follower像一个consumer一样，拉取leader对应分区的数据，并保存到日志数据文件中</li></ul><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219020926455-30f5e287.png" alt="image-20221219020926455" class="img_ev3q">image-20221219020926455</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-查看某个partition的leader">2、 <strong>查看某个partition的leader</strong><a href="#2-查看某个partition的leader" class="hash-link" aria-label="2-查看某个partition的leader的直接链接" title="2-查看某个partition的leader的直接链接">​</a></h4><p>使用Kafka-eagle查看某个topic的partition的leader在哪个服务器中。为了方便观察，我们创建一个名为leadertest的3个分区、3个副本的topic。</p><ol><li>点击「Topic」菜单下的「List」</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219020805897-897ac95e.png" alt="image-20221219020805897" class="img_ev3q">image-20221219020805897</p><ol><li>任意点击选择一个Topic</li><li><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219022111554-5dd56c39.png" alt="image-20221219022111554" class="img_ev3q">image-20221219022111554</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219022142032-0b489724.png" alt="image-20221219022142032" class="img_ev3q">image-20221219022142032</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3arisrosr">3、<strong>AR、ISR、OSR</strong><a href="#3arisrosr" class="hash-link" aria-label="3arisrosr的直接链接" title="3arisrosr的直接链接">​</a></h4><p>在实际环境中，leader有可能会出现一些故障，所以Kafka一定会选举出新的leader。在讲解leader选举之前，我们先要明确几个概念。Kafka中，把follower可以按照不同状态分为三类——AR、ISR、OSR。</p><ul><li>分区的所有副本称为 「AR」（Assigned Replicas——已分配的副本）</li><li>所有与leader副本保持一定程度同步的副本（包括 leader 副本在内）组成 「ISR」（In-Sync Replicas——在同步中的副本）</li><li>由于follower副本同步滞后过多的副本（不包括 leader 副本）组成 「OSR」（Out-of-Sync Replias）</li><li>AR = ISR + OSR</li><li>正常情况下，所有的follower副本都应该与leader副本保持同步，即AR = ISR，OSR集合为空。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-查看分区的isr">4、 <strong>查看分区的ISR</strong><a href="#4-查看分区的isr" class="hash-link" aria-label="4-查看分区的isr的直接链接" title="4-查看分区的isr的直接链接">​</a></h4><ol><li>使用Kafka Eagle查看某个Topic的partition的ISR有哪几个节点。</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219022444989-fa8355bc.png" alt="image-20221219022444989" class="img_ev3q">image-20221219022444989</p><ol><li>尝试关闭id为0的broker（杀掉该broker的进程），参看topic的ISR情况。</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219022550344-598e2005.png" alt="image-20221219022550344" class="img_ev3q">image-20221219022550344</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-leader选举">5、 <strong>Leader选举</strong><a href="#5-leader选举" class="hash-link" aria-label="5-leader选举的直接链接" title="5-leader选举的直接链接">​</a></h4><p>leader对于消息的写入以及读取是非常关键的，此时有两个疑问：</p><ol><li>Kafka如何确定某个partition是leader、哪个partition是follower呢？</li><li>某个leader崩溃了，如何快速确定另外一个leader呢？因为Kafka的吞吐量很高、延迟很低，所以选举leader必须非常快</li></ol><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1如果leader崩溃kafka会如何">（1）<strong>如果leader崩溃，Kafka会如何？</strong><a href="#1如果leader崩溃kafka会如何" class="hash-link" aria-label="1如果leader崩溃kafka会如何的直接链接" title="1如果leader崩溃kafka会如何的直接链接">​</a></h5><p>使用Kafka Eagle找到某个partition的leader，再找到leader所在的broker。在Linux中强制杀掉该Kafka的进程，然后观察leader的情况。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219022550344-598e2005.png" alt="image-20221219022550344" class="img_ev3q">image-20221219022550344</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219024139628-20e0e701.png" alt="image-20221219024139628" class="img_ev3q">image-20221219024139628</p><p>通过观察，我们发现，leader在崩溃后，Kafka又从其他的follower中快速选举出来了leader。</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2controller介绍">（2）Controller介绍<a href="#2controller介绍" class="hash-link" aria-label="（2）Controller介绍的直接链接" title="（2）Controller介绍的直接链接">​</a></h5><p>Kafka启动时，会在所有的broker中选择一个controller</p><p>前面leader和follower是针对partition，而controller是针对broker的</p><p>创建topic、或者添加分区、修改副本数量之类的管理任务都是由controller完成的</p><p>Kafka分区leader的选举，也是由controller决定的</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219024259251-9eed6e7f.png" alt="image-20221219024259251" class="img_ev3q">image-20221219024259251</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-controller的选举">（3） <strong>C</strong>ontroller的选举<a href="#3-controller的选举" class="hash-link" aria-label="3-controller的选举的直接链接" title="3-controller的选举的直接链接">​</a></h5><p>在Kafka集群启动的时候，每个broker都会尝试去ZooKeeper上注册成为Controller（ZK临时节点）</p><p>但只有一个竞争成功，其他的broker会注册该节点的监视器</p><p>一点该临时节点状态发生变化，就可以进行相应的处理</p><p>Controller也是高可用的，一旦某个broker崩溃，其他的broker会重新注册为Controller</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4-找到当前kafka集群的controller">（4） <strong>找到当前Kafka集群的controller</strong><a href="#4-找到当前kafka集群的controller" class="hash-link" aria-label="4-找到当前kafka集群的controller的直接链接" title="4-找到当前kafka集群的controller的直接链接">​</a></h5><ol><li>点击Kafka Tools的「Tools」菜单，找到「ZooKeeper Brower...」</li><li>点击左侧树形结构的controller节点，就可以查看到哪个broker是controller了。</li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219024440645-821ddd82.png" alt="image-20221219024440645" class="img_ev3q">image-20221219024440645</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5-测试controller选举">（5） <strong>测试controller选举</strong><a href="#5-测试controller选举" class="hash-link" aria-label="5-测试controller选举的直接链接" title="5-测试controller选举的直接链接">​</a></h5><p>通过kafka tools找到controller所在的broker对应的kafka进程，杀掉该进程，重新打开ZooKeeper brower，观察kafka是否能够选举出来新的Controller。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219024804743-c388e9c1.png" alt="image-20221219024804743" class="img_ev3q">image-20221219024804743</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6controller选举partition-leader">（6）<strong>Controller选举partition</strong> <strong>leader</strong><a href="#6controller选举partition-leader" class="hash-link" aria-label="6controller选举partition-leader的直接链接" title="6controller选举partition-leader的直接链接">​</a></h5><ul><li>所有Partition的leader选举都由controller决定</li><li>controller会将leader的改变直接通过RPC的方式通知需为此作出响应的Broker</li><li>controller读取到当前分区的ISR，只要有一个Replica还幸存，就选择其中一个作为leader否则，则任意选这个一个Replica作为leader</li><li>如果该partition的所有Replica都已经宕机，则新的leader为-1</li></ul><p>为什么不能通过ZK的方式来选举partition的leader？</p><ul><li>Kafka集群如果业务很多的情况下，会有很多的partition</li><li>假设某个broker宕机，就会出现很多的partiton都需要重新选举leader</li><li>如果使用zookeeper选举leader，会给zookeeper带来巨大的压力。所以，kafka中leader的选举不能使用ZK来实现</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6leader负载均衡">6、<strong>leader负载均衡</strong><a href="#6leader负载均衡" class="hash-link" aria-label="6leader负载均衡的直接链接" title="6leader负载均衡的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1preferred-replica">（1）Preferred Replica<a href="#1preferred-replica" class="hash-link" aria-label="（1）Preferred Replica的直接链接" title="（1）Preferred Replica的直接链接">​</a></h5><ul><li>Kafka中引入了一个叫做「preferred-replica」的概念，意思就是：优先的Replica</li><li>在ISR列表中，第一个replica就是preferred-replica</li><li>第一个分区存放的broker，肯定就是preferred-replica</li><li>执行以下脚本可以将preferred-replica设置为leader，均匀分配每个分区的leader。</li></ul><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">./kafka-leader-election.sh --bootstrap-server node1.ydlclass.com:9092 --topic leadertest3 --partition=1 --election-type preferred</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2确保leader在broker中负载均衡">（2）<strong>确保leader在broker中负载均衡</strong><a href="#2确保leader在broker中负载均衡" class="hash-link" aria-label="2确保leader在broker中负载均衡的直接链接" title="2确保leader在broker中负载均衡的直接链接">​</a></h5><p>杀掉leadertest3主题的某个broker，这样kafka会重新分配leader。等到Kafka重新分配leader之后，再次启动kafka进程。此时：观察test主题各个分区leader的分配情况。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219025639566-8a214a91.png" alt="image-20221219025639566" class="img_ev3q">image-20221219025639566</p><p>此时，会造成leader分配是不均匀的，所以可以执行以下脚本来重新分配leader:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-leader-election.sh --bootstrap-server node1.ydlclass.com:9092 --topic leadertest3 --partition=1 --election-type preferred</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>--partition：指定需要重新分配leader的partition编号</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二kafka生产消费数据工作流程面试">二、<strong>Kafka生产、消费数据工作流程</strong>(面试)<a href="#二kafka生产消费数据工作流程面试" class="hash-link" aria-label="二kafka生产消费数据工作流程面试的直接链接" title="二kafka生产消费数据工作流程面试的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-kafka数据写入流程">1、 <strong>Kafka数据写入流程</strong><a href="#1-kafka数据写入流程" class="hash-link" aria-label="1-kafka数据写入流程的直接链接" title="1-kafka数据写入流程的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219031320528-fe57c832.png" alt="image-20221219031320528" class="img_ev3q">image-20221219031320528</p><ul><li><p>生产者先从 zookeeper 的 &quot;/brokers/topics/主题名/partitions/分区名/state&quot;节点找到该 partition 的leader</p><p>  <img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219031618736-1067db9c.png" alt="image-20221219031618736" class="img_ev3q">image-20221219031618736</p></li><li><p>生产者在ZK中找到该ID找到对应的broker</p></li><li><p>broker进程上的leader将消息写入到本地log中</p></li><li><p>follower从leader上拉取消息，写入到本地log，并向leader发送ACK</p></li><li><p>leader接收到所有的ISR中的Replica的ACK后，并向生产者返回ACK。</p></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2kafka数据消费流程">2、<strong>Kafka数据消费流程</strong><a href="#2kafka数据消费流程" class="hash-link" aria-label="2kafka数据消费流程的直接链接" title="2kafka数据消费流程的直接链接">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-两种消费模式">（1） <strong>两种消费模式</strong><a href="#1-两种消费模式" class="hash-link" aria-label="1-两种消费模式的直接链接" title="1-两种消费模式的直接链接">​</a></h5><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219031954267-0da43bde.png" alt="image-20221219031954267" class="img_ev3q">image-20221219031954267</p><p>kafka采用拉取模型，由消费者自己记录消费状态，每个消费者互相独立地顺序拉取每个分区的消息</p><p>消费者可以按照任意的顺序消费消息。比如，消费者可以重置到旧的偏移量，重新处理之前已经消费过的消息；或者直接跳到最近的位置，从当前的时刻开始消费。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219032120151-6ecc4290.png" alt="image-20221219032120151" class="img_ev3q">image-20221219032120151</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-kafka消费数据流程">（2） <strong>Kafka消费数据流程</strong><a href="#2-kafka消费数据流程" class="hash-link" aria-label="2-kafka消费数据流程的直接链接" title="2-kafka消费数据流程的直接链接">​</a></h5><ul><li>每个consumer都可以根据分配策略（默认RangeAssignor），获得要消费的分区</li><li>获取到consumer对应的offset（默认从ZK中获取上一次消费的offset）</li><li>找到该分区的leader，拉取数据</li><li>消费者提交offset</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三-kafka的数据存储形式">三、 <strong>Kafka的数据存储形式</strong><a href="#三-kafka的数据存储形式" class="hash-link" aria-label="三-kafka的数据存储形式的直接链接" title="三-kafka的数据存储形式的直接链接">​</a></h3><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219034409180-1db59857.png" alt="image-20221219034409180" class="img_ev3q">image-20221219034409180</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219034708490-9cedc6bd.png" alt="image-20221219034708490" class="img_ev3q">image-20221219034708490</p><p>一个topic由多个分区组成</p><p>一个分区（partition）由多个segment（段）组成</p><p>一个segment（段）由多个文件组成（log、index、timeindex）</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-存储日志">1、 <strong>存储日志</strong><a href="#1-存储日志" class="hash-link" aria-label="1-存储日志的直接链接" title="1-存储日志的直接链接">​</a></h4><p>接下来，我们来看一下Kafka中的数据到底是如何在磁盘中存储的。</p><p>Kafka中的数据是保存在 /export/server/kafka_2.13-3.3.1/data中</p><p>消息是保存在以：「主题名-分区ID」的文件夹中的</p><p>数据文件夹中包含以下内容</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219034409180-1db59857.png" alt="image-20221219034409180" class="img_ev3q">image-20221219034409180</p><p>这些分别对应：</p><table><thead><tr><th>文件名</th><th>说明</th></tr></thead><tbody><tr><td>00000000000000000000.index</td><td>索引文件，根据offset查找数据就是通过该索引文件来操作的</td></tr><tr><td>00000000000000000000.log</td><td>日志数据文件</td></tr><tr><td>00000000000000000000.timeindex</td><td>时间索引</td></tr><tr><td>leader-epoch-checkpoint</td><td>持久化每个partition leader对应的LEO（log end offset、日志文件中下一条待写入消息的offset）</td></tr></tbody></table><p>每个日志文件的文件名为起始偏移量，因为每个分区的起始偏移量是0，所以，分区的日志文件都以0000000000000000000.log开始</p><p>默认的每个日志文件最大为「log.segment.bytes =1024<em>1024</em>1024」1G</p><p>为了简化根据offset查找消息，Kafka日志文件名设计为开始的偏移量</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1观察测试">（1）<strong>观察测试</strong><a href="#1观察测试" class="hash-link" aria-label="1观察测试的直接链接" title="1观察测试的直接链接">​</a></h5><p><strong>作业：</strong></p><p>为了方便测试观察，新创建一个topic：「itlils_1m」，该topic每个日志数据文件最大为1M</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-topics.sh --create --zookeeper node1.ydlclass.com --topic itlils_1m --replication-factor 2 --partitions 3 --config segment.bytes=1048576</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用之前的生产者程序往「itlils_1m」主题中生产数据，可以观察到如下：</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2写入消息">（2）<strong>写入消息</strong><a href="#2写入消息" class="hash-link" aria-label="2写入消息的直接链接" title="2写入消息的直接链接">​</a></h5><p>新的消息总是写入到最后的一个日志文件中</p><p>该文件如果到达指定的大小（默认为：1GB）时，将滚动到一个新的文件中</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219035839102-b0c035ad.png" alt="image-20221219035839102" class="img_ev3q">image-20221219035839102</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3读取消息">（3）<strong>读取消息</strong><a href="#3读取消息" class="hash-link" aria-label="3读取消息的直接链接" title="3读取消息的直接链接">​</a></h5><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219035947865-af3452ea.png" alt="image-20221219035947865" class="img_ev3q">image-20221219035947865</p><p>根据「offset」首先需要找到存储数据的 segment 段（注意：offset指定分区的全局偏移量）</p><p>然后根据这个「全局分区offset」找到相对于文件的「segment段offset」</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219040011138-c78cc5ce.png" alt="image-20221219040011138" class="img_ev3q">image-20221219040011138</p><p>最后再根据 「segment段offset」读取消息</p><p>为了提高查询效率，每个文件都会维护对应的范围内存，查找的时候就是使用简单的二分查找</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4删除消息">（4）<strong>删除消息</strong><a href="#4删除消息" class="hash-link" aria-label="4删除消息的直接链接" title="4删除消息的直接链接">​</a></h5><p>在Kafka中，消息是会被*<strong>*定期清理**</strong>的。一次删除一个segment段的日志文件</p><p>Kafka的日志管理器，会根据Kafka的配置，来决定哪些文件可以被删除</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四-消息不丢失机制">四、 <strong>消息不丢失机制</strong><a href="#四-消息不丢失机制" class="hash-link" aria-label="四-消息不丢失机制的直接链接" title="四-消息不丢失机制的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1broker数据不丢失">1、<strong>broker数据不丢失</strong><a href="#1broker数据不丢失" class="hash-link" aria-label="1broker数据不丢失的直接链接" title="1broker数据不丢失的直接链接">​</a></h4><p>生产者通过分区的leader写入数据后，所有在ISR中follower都会从leader中复制数据，这样，可以确保即使leader崩溃了，其他的follower的数据仍然是可用的</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2生产者数据不丢失">2、<strong>生产者数据不丢失</strong><a href="#2生产者数据不丢失" class="hash-link" aria-label="2生产者数据不丢失的直接链接" title="2生产者数据不丢失的直接链接">​</a></h4><p>生产者连接leader写入数据时，可以通过ACK机制来确保数据已经成功写入。ACK机制有三个可选配置</p><ol><li>配置ACK响应要求为 -1 时 —— 表示所有的节点都收到数据(leader和follower都接收到数据）</li><li>配置ACK响应要求为 1 时 —— 表示leader收到数据</li><li>配置ACK影响要求为 0 时 —— 生产者只负责发送数据，不关心数据是否丢失（这种情况可能会产生数据丢失，但性能是最好的）</li></ol><p>生产者可以采用同步和异步两种方式发送数据</p><p>同步：发送一批数据给kafka后，等待kafka返回结果</p><p>异步：发送一批数据给kafka，只是提供一个回调函数。</p><p>说明：如果broker迟迟不给ack，而buﬀer又满了，开发者可以设置是否直接清空buﬀer中的数据。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3消费者数据不丢失">3、<strong>消费者数据不丢失</strong><a href="#3消费者数据不丢失" class="hash-link" aria-label="3消费者数据不丢失的直接链接" title="3消费者数据不丢失的直接链接">​</a></h4><p>在消费者消费数据的时候，只要每个消费者记录好oﬀset值即可，就能保证数据不丢失。</p><ul><li><p>at-most-once:最多消费一次。会有消息丢失问题</p><p>  <img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219041842467-34b444ff.png" alt="image-20221219041842467" class="img_ev3q">image-20221219041842467</p></li><li><p>ad-least-once：消息最少消费一次。会有消息重复问题</p><p>  <img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219042114917-f4ae2c7b.png" alt="image-20221219042114917" class="img_ev3q">image-20221219042114917</p></li><li><p>exactly-once：恰好消息消费一次。</p></li></ul><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219042337016-d8190f2b.png" alt="image-20221219042337016" class="img_ev3q">image-20221219042337016</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五数据积压">五、<strong>数据积压</strong><a href="#五数据积压" class="hash-link" aria-label="五数据积压的直接链接" title="五数据积压的直接链接">​</a></h3><p>Kafka消费者消费数据的速度是非常快的，但如果由于处理Kafka消息时，由于有一些外部IO、或者是产生网络拥堵，就会造成Kafka中的数据积压（或称为数据堆积）。如果数据一直积压，会导致数据出来的实时性受到较大影响。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1使用kafka-eagle查看数据积压情况">1、<strong>使用Kafka-Eagle查看数据积压情况</strong><a href="#1使用kafka-eagle查看数据积压情况" class="hash-link" aria-label="1使用kafka-eagle查看数据积压情况的直接链接" title="1使用kafka-eagle查看数据积压情况的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219043703624-13c39ed2.png" alt="image-20221219043703624" class="img_ev3q">image-20221219043703624</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-解决数据积压问题">2、 <strong>解决数据积压问题</strong><a href="#2-解决数据积压问题" class="hash-link" aria-label="2-解决数据积压问题的直接链接" title="2-解决数据积压问题的直接链接">​</a></h4><p>当Kafka出现数据积压问题时，首先要找到数据积压的原因。以下是在企业中出现数据积压的几个类场景。</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-数据写入mysql失败">（1） <strong>数据写入MySQL失败</strong><a href="#1-数据写入mysql失败" class="hash-link" aria-label="1-数据写入mysql失败的直接链接" title="1-数据写入mysql失败的直接链接">​</a></h5><p><strong>问题描述</strong></p><p>某日运维人员找到开发人员，说某个topic的一个分区发生数据积压，这个topic非常重要，而且开始有用户投诉。运维非常紧张，赶紧重启了这台机器。重启之后，还是无济于事。</p><p><strong>问题分析</strong></p><p>消费这个topic的代码比较简单，主要就是消费topic数据，然后进行判断在进行数据库操作。运维通过kafka-eagle找到积压的topic，发现该topic的某个分区积压了几十万条的消息。</p><p>最后，通过查看日志发现，由于数据写入到MySQL中报错，导致消费分区的offset一自没有提交，所以数据积压严重。</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-因为网络延迟消费失败">（2） <strong>因为网络延迟消费失败</strong><a href="#2-因为网络延迟消费失败" class="hash-link" aria-label="2-因为网络延迟消费失败的直接链接" title="2-因为网络延迟消费失败的直接链接">​</a></h5><p>问题描述</p><p>基于Kafka开发的系统平稳运行了两个月，突然某天发现某个topic中的消息出现数据积压，大概有几万条消息没有被消费。</p><p>问题分析</p><p>通过查看应用程序日志发现，有大量的消费超时失败。后查明原因，因为当天网络抖动，通过查看Kafka的消费者超时配置为50ms，随后，将消费的时间修改为500ms后问题解决。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第五章-kafka中数据清理log-deletion">第五章 Kafka中数据清理（Log Deletion）<a href="#第五章-kafka中数据清理log-deletion" class="hash-link" aria-label="第五章 Kafka中数据清理（Log Deletion）的直接链接" title="第五章 Kafka中数据清理（Log Deletion）的直接链接">​</a></h2><p>Kafka的消息存储在磁盘中，为了控制磁盘占用空间，Kafka需要不断地对过去的一些消息进行清理工作。Kafka的每个分区都有很多的日志文件，这样也是为了方便进行日志的清理。在Kafka中，提供两种日志清理方式：</p><ul><li>日志删除（Log Deletion）：按照指定的策略*<strong>*直接删除**</strong>不符合条件的日志。</li><li>日志压缩（Log Compaction）：按照消息的key进行整合，有相同key的但有不同value值，只保留最后一个版本。</li></ul><p>在Kafka的broker或topic配置中：</p><table><thead><tr><th>配置项</th><th>配置值</th><th>说明</th></tr></thead><tbody><tr><td>log.cleaner.enable</td><td>true（默认）</td><td>开启自动清理日志功能</td></tr><tr><td>log.cleanup.policy</td><td>delete（默认）</td><td>删除日志</td></tr><tr><td>log.cleanup.policy</td><td>compaction</td><td>压缩日志</td></tr><tr><td>log.cleanup.policy</td><td>delete,compact</td><td>同时支持删除、压缩</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一日志删除">一、<strong>日志删除</strong><a href="#一日志删除" class="hash-link" aria-label="一日志删除的直接链接" title="一日志删除的直接链接">​</a></h3><p>日志删除是以段（segment日志）为单位来进行定期清理的。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1定时日志删除任务">1、<strong>定时日志删除任务</strong><a href="#1定时日志删除任务" class="hash-link" aria-label="1定时日志删除任务的直接链接" title="1定时日志删除任务的直接链接">​</a></h4><p>Kafka日志管理器中会有一个专门的日志删除任务来定期检测和删除不符合保留条件的日志分段文件，这个周期可以通过broker端参数log.retention.check.interval.ms来配置，默认值为300,000，即5分钟。当前日志分段的保留策略有3种：</p><ol><li>基于时间的保留策略</li><li>基于日志大小的保留策略</li><li>基于日志起始偏移量的保留策略</li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2基于时间的保留策略">2、<strong>基于时间的保留策略</strong><a href="#2基于时间的保留策略" class="hash-link" aria-label="2基于时间的保留策略的直接链接" title="2基于时间的保留策略的直接链接">​</a></h4><p>以下三种配置可以指定如果Kafka中的消息超过指定的阈值，就会将日志进行自动清理：</p><p>log.retention.hours</p><p>log.retention.minutes</p><p><a href="http://log.retention.ms/" target="_blank" rel="noopener noreferrer">log.retention.msopen in new window</a></p><p>其中，优先级为 <a href="http://log.retention.ms/" target="_blank" rel="noopener noreferrer">log.retention.msopen in new window</a> &gt; log.retention.minutes &gt; log.retention.hours。默认情况，在broker中，配置如下：</p><p>log.retention.hours=168</p><p>也就是，默认日志的保留时间为168小时，相当于保留7天。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219045111975-13948b2c.png" alt="image-20221219045111975" class="img_ev3q">image-20221219045111975</p><p>删除日志分段时:</p><ol><li>从日志文件对象中所维护日志分段的跳跃表中移除待删除的日志分段，以保证没有线程对这些日志分段进行读取操作</li><li>将日志分段文件添加上“.deleted”的后缀（也包括日志分段对应的索引文件）</li><li>Kafka的后台定时任务会定期删除这些“.deleted”为后缀的文件，这个任务的延迟执行时间可以通过file.delete.delay.ms参数来设置，默认值为60000，即1分钟。</li></ol><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-设置topic-5秒删除一次">（1） <strong>设置topic 5秒删除一次</strong><a href="#1-设置topic-5秒删除一次" class="hash-link" aria-label="1-设置topic-5秒删除一次的直接链接" title="1-设置topic-5秒删除一次的直接链接">​</a></h5><ol><li>为了方便观察，设置段文件的大小为1M。</li></ol><p>key: segment.bytes</p><p>value: 1048576</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219045406370-70a8255e.png" alt="image-20221219045406370" class="img_ev3q">image-20221219045406370</p><ol><li>设置topic的删除策略</li></ol><p>key: <a href="http://retention.ms/" target="_blank" rel="noopener noreferrer">retention.msopen in new window</a></p><p>value: 5000</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219045436332-fe89062e.png" alt="image-20221219045436332" class="img_ev3q">image-20221219045436332</p><p>尝试往topic中添加一些数据，等待一会，观察日志的删除情况。我们发现，日志会定期被标记为删除，然后被删除。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-基于日志大小的保留策略">3、 <strong>基于日志大小的保留策略</strong><a href="#3-基于日志大小的保留策略" class="hash-link" aria-label="3-基于日志大小的保留策略的直接链接" title="3-基于日志大小的保留策略的直接链接">​</a></h4><p>日志删除任务会检查当前日志的大小是否超过设定的阈值来寻找可删除的日志分段的文件集合。可以通过broker端参数 log.retention.bytes 来配置，默认值为-1，表示无穷大。如果超过该大小，会自动将超出部分删除。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219045531449-030f0474.png" alt="image-20221219045531449" class="img_ev3q">image-20221219045531449</p><p>注意:</p><p>log.retention.bytes 配置的是日志文件的总大小，而不是单个的日志分段的大小，一个日志文件包含多个日志分段。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4基于日志起始偏移量保留策略">4、<strong>基于日志起始偏移量保留策略</strong><a href="#4基于日志起始偏移量保留策略" class="hash-link" aria-label="4基于日志起始偏移量保留策略的直接链接" title="4基于日志起始偏移量保留策略的直接链接">​</a></h4><p>每个segment日志都有它的起始偏移量，如果起始偏移量小于 logStartOffset，那么这些日志文件将会标记为删除。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219045610438-ea7372a1.png" alt="image-20221219045610438" class="img_ev3q">image-20221219045610438</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5日志压缩log-compaction">5、日志压缩（Log Compaction）<a href="#5日志压缩log-compaction" class="hash-link" aria-label="5、日志压缩（Log Compaction）的直接链接" title="5、日志压缩（Log Compaction）的直接链接">​</a></h3><p>Log Compaction是默认的日志删除之外的清理过时数据的方式。它会将相同的key对应的数据只保留一个版本。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20221219045736302-7d58ac48.png" alt="image-20221219045736302" class="img_ev3q">image-20221219045736302</p><ul><li>Log Compaction执行后，offset将不再连续，但依然可以查询Segment</li><li>Log Compaction执行前后，日志分段中的每条消息偏移量保持不变。Log Compaction会生成一个新的Segment文件</li><li>Log Compaction是针对key的，在使用的时候注意每个消息的key不为空</li><li>基于Log Compaction可以保留key的最新更新，可以基于Log Compaction来恢复消费者的最新状态</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第六章-kafka配额限速机制quotas">第六章 Kafka配额限速机制（Quotas）<a href="#第六章-kafka配额限速机制quotas" class="hash-link" aria-label="第六章 Kafka配额限速机制（Quotas）的直接链接" title="第六章 Kafka配额限速机制（Quotas）的直接链接">​</a></h2><p>生产者和消费者以极高的速度生产/消费大量数据或产生请求，从而占用broker上的全部资源，造成网络IO饱和。有了配额（Quotas）就可以避免这些问题。Kafka支持配额管理，从而可以对Producer和Consumer的produce&amp;fetch操作进行流量限制，防止个别业务压爆服务器。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一-限制producer端速率">一、 <strong>限制producer端速率</strong><a href="#一-限制producer端速率" class="hash-link" aria-label="一-限制producer端速率的直接链接" title="一-限制producer端速率的直接链接">​</a></h3><p>为所有client id设置默认值，以下为所有producer程序设置其TPS不超过1MB/s，即1048576‬/s，命令如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-configs.sh --zookeeper node1.ydlclass.com:2181 --alter --add-config &#x27;producer_byte_rate=1048576&#x27; --entity-type clients --entity-default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>运行基准测试，观察生产消息的速率</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-producer-perf-test.sh --topic test --num-records 500000 --throughput -1 --record-size 1000 --producer-props bootstrap.servers=node1.ydlclass.com:9092,node2.ydlclass.com:9092,node3.ydlclass.com:9092 acks=1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结果：</p><p>50000 records sent, 1108.156028 records/sec (1.06 MB/sec)</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二限制consumer端速率">二、<strong>限制consumer端速率</strong><a href="#二限制consumer端速率" class="hash-link" aria-label="二限制consumer端速率的直接链接" title="二限制consumer端速率的直接链接">​</a></h3><p>对consumer限速与producer类似，只不过参数名不一样。</p><p>为指定的topic进行限速，以下为所有consumer程序设置topic速率不超过1MB/s，即1048576/s。命令如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-configs.sh --zookeeper node1.ydlclass.com:2181 --alter --add-config &#x27;consumer_byte_rate=1048576&#x27; --entity-type clients --entity-default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>运行基准测试：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-consumer-perf-test.sh --broker-list node1.ydlclass.com:9092,node2.ydlclass.com:9092,node3.ydlclass.com:9092 --topic test --fetch-size 1048576 --messages 500000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>结果为：</p><p>MB.sec：1.0743</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三取消kafka的quota配置">三、<strong>取消Kafka的Quota配置</strong><a href="#三取消kafka的quota配置" class="hash-link" aria-label="三取消kafka的quota配置的直接链接" title="三取消kafka的quota配置的直接链接">​</a></h3><p>使用以下命令，删除Kafka的Quota配置</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-configs.sh --zookeeper node1.ydlclass.com:2181 --alter --delete-config &#x27;producer_byte_rate&#x27; --entity-type clients --entity-default</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">bin/kafka-configs.sh --zookeeper node1.ydlclass.com:2181 --alter --delete-config &#x27;consumer_byte_rate&#x27; --entity-type clients --entity-default </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Java/7.中间件/3.4 kafka高级.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Java/中间件/3.3 Kafka入门"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">3.3 Kafka入门</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Java/框架扩展/SpringCloud"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">1. SpringCloud</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#第一章-分区和副本机制" class="table-of-contents__link toc-highlight">第一章 分区和副本机制</a><ul><li><a href="#一生产者分区写入策略" class="table-of-contents__link toc-highlight">一、<strong>生产者分区写入策略</strong></a></li><li><a href="#二-消费者组rebalance机制" class="table-of-contents__link toc-highlight">二、 消费者组Rebalance机制</a></li><li><a href="#三消费者分区分配策略" class="table-of-contents__link toc-highlight">三、<strong>消费者分区分配策略</strong></a></li><li><a href="#四副本机制" class="table-of-contents__link toc-highlight">四、<strong>副本机制</strong></a></li></ul></li><li><a href="#第二章-高级high-levelapi与低级low-levelapi" class="table-of-contents__link toc-highlight">第二章 高级（High Level）API与低级（Low Level）API</a><ul><li><a href="#一-高级api" class="table-of-contents__link toc-highlight">一、 <strong>高级API</strong></a></li><li><a href="#二低级api" class="table-of-contents__link toc-highlight">二、<strong>低级API</strong></a></li><li><a href="#三-手动消费分区数据" class="table-of-contents__link toc-highlight">三、 <strong>手动消费分区数据</strong></a></li></ul></li><li><a href="#第三章-监控工具kafka-eagle介绍" class="table-of-contents__link toc-highlight">第三章 监控工具Kafka-eagle介绍</a><ul><li><a href="#一-kafka-eagle简介" class="table-of-contents__link toc-highlight">一、 <strong>Kafka-Eagle简介</strong></a></li><li><a href="#二-安装kafka-eagle" class="table-of-contents__link toc-highlight">二、 <strong>安装Kafka-Eagle</strong></a></li><li><a href="#三-kafka度量指标" class="table-of-contents__link toc-highlight">三、 <strong>Kafka度量指标</strong></a></li></ul></li><li><a href="#第四章-kafka原理" class="table-of-contents__link toc-highlight">第四章 Kafka原理</a><ul><li><a href="#一分区的leader与follower" class="table-of-contents__link toc-highlight">一、<strong>分区的leader与follower</strong></a></li><li><a href="#二kafka生产消费数据工作流程面试" class="table-of-contents__link toc-highlight">二、<strong>Kafka生产、消费数据工作流程</strong>(面试)</a></li><li><a href="#三-kafka的数据存储形式" class="table-of-contents__link toc-highlight">三、 <strong>Kafka的数据存储形式</strong></a></li><li><a href="#四-消息不丢失机制" class="table-of-contents__link toc-highlight">四、 <strong>消息不丢失机制</strong></a></li><li><a href="#五数据积压" class="table-of-contents__link toc-highlight">五、<strong>数据积压</strong></a></li></ul></li><li><a href="#第五章-kafka中数据清理log-deletion" class="table-of-contents__link toc-highlight">第五章 Kafka中数据清理（Log Deletion）</a><ul><li><a href="#一日志删除" class="table-of-contents__link toc-highlight">一、<strong>日志删除</strong></a></li><li><a href="#5日志压缩log-compaction" class="table-of-contents__link toc-highlight">5、日志压缩（Log Compaction）</a></li></ul></li><li><a href="#第六章-kafka配额限速机制quotas" class="table-of-contents__link toc-highlight">第六章 Kafka配额限速机制（Quotas）</a><ul><li><a href="#一-限制producer端速率" class="table-of-contents__link toc-highlight">一、 <strong>限制producer端速率</strong></a></li><li><a href="#二限制consumer端速率" class="table-of-contents__link toc-highlight">二、<strong>限制consumer端速率</strong></a></li><li><a href="#三取消kafka的quota配置" class="table-of-contents__link toc-highlight">三、<strong>取消Kafka的Quota配置</strong></a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.730de416.js"></script>
<script src="/assets/js/main.887d1c07.js"></script>
</body>
</html>