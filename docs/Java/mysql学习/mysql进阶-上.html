<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Java/mysql学习/mysql进阶-上">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">mysql进阶-上 | SUITABLE</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://october-x.github.io/docs/Java/mysql学习/mysql进阶-上"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="keywords" content="frontend, react, javascript, css, react, vue, typescript, docusaurus, blog, personal blog, personal website,html"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="mysql进阶-上 | SUITABLE"><meta data-rh="true" name="description" content="第一章 mysql架构"><meta data-rh="true" property="og:description" content="第一章 mysql架构"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://october-x.github.io/docs/Java/mysql学习/mysql进阶-上"><link data-rh="true" rel="alternate" href="https://october-x.github.io/docs/Java/mysql学习/mysql进阶-上" hreflang="zh"><link data-rh="true" rel="alternate" href="https://october-x.github.io/docs/Java/mysql学习/mysql进阶-上" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://8YE83IQFLA-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="SUITABLE RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="SUITABLE Atom Feed">



<link rel="search" type="application/opensearchdescription+xml" title="SUITABLE" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.12e922a4.css">
<link rel="preload" href="/assets/js/runtime~main.730de416.js" as="script">
<link rel="preload" href="/assets/js/main.887d1c07.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">SUITABLE</b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/docs/Interview">Study</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Skill</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/html">HTML</a></li><li><a class="dropdown__link" href="/docs/css">CSS</a></li><li><a class="dropdown__link" href="/docs/js">JavaScript</a></li><li><a class="dropdown__link" href="/docs/vue">Vue</a></li><li><a class="dropdown__link" href="/docs/vue3">Vue3</a></li><li><a class="dropdown__link" href="/docs/ts">TypeSript</a></li><li><a class="dropdown__link" href="/docs/react">React</a></li><li><a class="dropdown__link" href="/docs/nodejs">NodeJS</a></li><li><a class="dropdown__link" href="/docs/webpack">WebPack</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Java">Java</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><b>SUITABLE</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" href="/docs/Java">Java</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/JavaSE/计算机基础和java环境搭建">JavaSE</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java">目录</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/其他/GIT入门">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/Java/mysql学习/mysql入门">mysql学习</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/mysql学习/mysql入门">mysql入门</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Java/mysql学习/mysql进阶-上">mysql进阶-上</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/mysql学习/mysql进阶-下">mysql进阶-下</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/mysql学习/JDBC">JDBC</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/web/CSS">web</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/基础知识/日志框架">基础知识</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/框架/MyBatis">框架</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/中间件/nginx">中间件</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/框架扩展/SpringCloud">框架扩展</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/Docker">9. Docker</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/Java/项目/短信调度">项目</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Java/数据结构与算法-基础">11. 数据结构与算法-基础</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">mysql学习</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">mysql进阶-上</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>mysql进阶-上</h1><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第一章-mysql架构">第一章 mysql架构<a href="#第一章-mysql架构" class="hash-link" aria-label="第一章 mysql架构的直接链接" title="第一章 mysql架构的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一mysql的系统架构">一、mysql的系统架构<a href="#一mysql的系统架构" class="hash-link" aria-label="一、mysql的系统架构的直接链接" title="一、mysql的系统架构的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-数据库和数据库实例">1、 数据库和数据库实例<a href="#1-数据库和数据库实例" class="hash-link" aria-label="1、 数据库和数据库实例的直接链接" title="1、 数据库和数据库实例的直接链接">​</a></h4><p>在MySQL的学习研究中，存在几个非常容易混淆的概念，即【数据库】、【数据库软件】和【数据库实例】：</p><ul><li>数据库：按照数据结构来组织、存储和管理数据的仓库，通常由数据库管理系统进行管理。</li><li>数据库管理软件（RDBMS）：就是我们说的数据库管理系统软件，他强调软件。</li><li>数据库实例：启动数据库软件，在内存中运行一个独立进程，用来操作数据，这个正在运行的进程就是一个数据库实例，理论上可以在一台电脑上启动多个数据库实例，当然要监听在不同的端口。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2mysql架构">2、MySQL架构<a href="#2mysql架构" class="hash-link" aria-label="2、MySQL架构的直接链接" title="2、MySQL架构的直接链接">​</a></h4><p>复杂的架构是为了更好的工作，架构中的每一个角色都可以高效的单独处理一类事件，辅助整个系统的流畅运行，举个例子：</p><p>每天有很多人拜访市长，为了能合理的给市长安排拜访工作，需要对拜访流程做出复杂设计，比如先要在门卫处做身份认证、由传达室负责接通电话确认是否可以访问、市长办公室负责接待、你可能需要排队等候、你的事情如果办公室就能解决可能就不用见市长了，最后轮到你了，你才能见上市长，整个拜访流程就是设计的架构。</p><p>对于MySQL来说，虽然经历了多个版本迭代（MySQL5.5,MySQL 5.6,MySQL 5.7,MySQL 8）,但每次的迭代，都是基于MySQL基架的，MySQL基架大致包括如下几大模块组件，如下图：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220425170356906-b2a52c35.png" alt="image-20220425170356906" class="img_ev3q">image-20220425170356906</p><p><strong>（1）MySQL向外提供的交互接口（Connectors）</strong></p><p>Connectors组件，是MySQL向外提供的交互组件，如java,.net,php等语言可以通过该组件来操作SQL语句，实现与SQL的交互。通过客户端/服务器通信协议与MySQL建立连接。MySQL 客户端与服务端的通信方式是 “ 半双工 ”。对于每一个 MySQL 的连接，时刻都有一个线程状态来标识这个连接正在做什么。</p><p><strong>（2）管理服务组件和工具组件(Management Service &amp; Utilities)</strong></p><p>提供MySQL的各项服务组件和管理工具，如备份(Backup)，恢复(Recovery)，安全管理(Security)等功能。</p><p><strong>（3）连接池组件(Connection Pool)</strong></p><p>负责监听客户端向MySQL Server端的各种请求，接收请求，转发请求到目标模块。每个成功连接MySQL Server的客户请求都会被创建或分配一个线程，该线程负责客户端与MySQL Server端的通信，接收客户端发送的命令，传递服务端的结果信息等。</p><p><strong>（4）SQL接口组件(SQL Interface)</strong></p><p>接收用户SQL命令，如DML,DDL和存储过程等，并将最终结果返回给用户。</p><p><strong>（5）查询分析器组件(Parser)</strong></p><p>首先分析SQL命令语法的合法性，并进行抽象语法树解析，如果sql有语法错误，会抛出异常信息。</p><p><strong>（6）优化器组件（Optimizer）</strong></p><p>对SQL命令按照标准流程进行优化分析，mysql会按照它认为的最优方式进行优化，选用成本最小的执行计划。</p><p><strong>（7）缓存主件（Caches &amp; Buffers）</strong></p><p>缓存和缓冲组件，这里边的内容我们后边会详细的讲解。</p><p><strong>（8）MySQL存储引擎</strong></p><p>MySQL属于关系型数据库，而关系型数据库的存储是以表的形式进行的，对于表的创建，数据的存储，检索，更新等都是由MySQL存储引擎完成的。</p><p>MySQL存储引擎在MySQL中扮演着重要角色。研究过SQL Server和Oracle的读者可能很清楚，这两种数据库的存储引擎只有一个，而MySQL的存储引擎种类比较多，如MyIsam存储引擎，InnoDB存储引擎和Memory存储引擎。</p><p>因为mysql本身就是开源的，他允许第三方基于MySQL骨架，开发适合自己业务需求的存储引擎。从MySQL存储引擎种类上来说，可以分为官方存储引擎和第三方存储引擎，比较常用的存储引擎包括InnoDB存储引擎，MyIsam存储引擎和Momery存储引擎。</p><p><strong>查询流程大致如下：</strong></p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195802351-3a69069f.png" alt="image-20220424195802351" class="img_ev3q">image-20220424195802351</p><p><strong>小问题：MySQL8.0为什么取消了查询缓存？</strong></p><p>【MySQL缓存机制】简单的说就是缓存sql文本及查询结果，如果运行完全相同的SQL，服务器直接从缓存中取到结果，而不需要再去解析和执行SQL。但如果表中任何数据或是结构发生改变，包括INSERT、UPDATE、DELETE、TRUNCATE、ALTER TABLE、DROP TABLE或DROP DATABASE等，那么使用这个表的所有缓存查询将不再有效，查询缓存中相关条目被清空。缓存是对系统性能优化的重要手段。但是有经验的DBA都建议生产环境中把MySQL Query Cache关闭。MySQL8.0更是直接取消了查询缓存，其原因有下：</p><ul><li>MySQL会对每条接收到的SELECT类型的查询进行hash计算，然后查找这个查询的缓存结果是否存在。虽然hash计算和查找的效率已经足够高了，一条查询语句所带来的开销可以忽略，但一旦涉及到高并发，有成千上万条查询语句时，hash计算和查找所带来的开销就必须重视了。</li><li>查询语句的字符大小写、空格或者注释的不同，Query Cache都会认为是不同的查询（因为他们的hash值会不同）。</li><li>当向某个表写入数据的时候，必须将和这个表相关的所有缓存设置为失效，如果缓存内容很多，则消耗也会很大，可能使系统僵死，因为这个操作是靠全局锁操作来保护的。</li></ul><p>当然还有一些其他原因，我们学习的过程中慢慢体会。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二目录结构">二、目录结构<a href="#二目录结构" class="hash-link" aria-label="二、目录结构的直接链接" title="二、目录结构的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1windows中的目录">1、windows中的目录<a href="#1windows中的目录" class="hash-link" aria-label="1、windows中的目录的直接链接" title="1、windows中的目录的直接链接">​</a></h4><p>在mysql启动的时候，会从【安装目录】加载软件数据，在运行过程中，会从【数据目录】中读取数据。这两个目录我们不要放在一起，避免重新安装软件导致数据丢失。</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-mysql安装目录">（1） mysql安装目录<a href="#1-mysql安装目录" class="hash-link" aria-label="（1） mysql安装目录的直接链接" title="（1） mysql安装目录的直接链接">​</a></h5><p>默认安装目录：C:\Program Files\MySQL</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195435853-ffca9813.png" alt="image-20220424195435853" class="img_ev3q">image-20220424195435853</p><ul><li><code>bin</code>目录：用于放置一些可执行的工具文件，如mysql.exe、mysqld.exe、mysqlshow.exe等。</li><li><code>include</code>目录：用于放置一些头文件，如：mysql.h、mysql_ername.h等。</li><li><code>lib</code>目录：用于放置一系列库文件。</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2数据文件目录重要">（2）数据文件目录（重要）<a href="#2数据文件目录重要" class="hash-link" aria-label="（2）数据文件目录（重要）的直接链接" title="（2）数据文件目录（重要）的直接链接">​</a></h5><p>默认数据目录：C:\ProgramData\MySQL\MySQL Server 8.0，注意ProgramData是一个隐藏目录，需要设置为【显示隐藏文件】：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195619219-9d7ce386.png" alt="image-20220424195619219" class="img_ev3q">image-20220424195619219</p><p><code>data</code>目录：用于放置一些日志文件以及数据库。</p><p>我们发现在data目录保存的是我们的真是的数据，每个数据库一个文件夹：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424235111862-444cb544.png" alt="image-20220424235111862" class="img_ev3q">image-20220424235111862</p><p>每张表又是一个独立的文件，不同的存储引擎的文件存储方式不同：不仅能快没了，</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424235244545-35dc0cdb.png" alt="image-20220424235244545" class="img_ev3q">image-20220424235244545</p><ul><li><p>my.ini的部分截图如下：</p><p>  <img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424234944753-ede12acc.png" alt="image-20220424234944753" class="img_ev3q">image-20220424234944753</p></li></ul><p>配置文件很重要，所谓配置文件就是配置一下你的mysql让他成为你想要的的样子，这里可以配置大量的信息，我们放在文档最后的附录。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2linux中的文件目录">2、linux中的文件目录<a href="#2linux中的文件目录" class="hash-link" aria-label="2、linux中的文件目录的直接链接" title="2、linux中的文件目录的直接链接">​</a></h4><p>linux的各项目录可以在我们安装时自由选定，我们选取一个云服务器，看看里边的mysql的目录结构：</p><p>（1）我们可以通过配置文件查看当前mysql的一些基本信息，linux中的配置文件在etc目录 ，名称为my.cnf，如下：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220507095721892-f5e6adbd.png" alt="image-20220507095721892" class="img_ev3q">image-20220507095721892</p><p>（2）bin目录，一些可执行文件，包括</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220507102512199-e2f47841.png" alt="image-20220507102512199" class="img_ev3q">image-20220507102512199</p><p><strong>bin目录工具汇总：</strong></p><blockquote><p>MySQL服务器端工具</p></blockquote><ul><li>mysqld：SQL后台保护程序(MySQL服务器进程)。该程序必须运行之后。客户端才能通过连接服务器端程序访问和操作数据库。</li><li>mysqld_safe：MySQL服务脚本。mysql_safe增加了一些安全特性，如当出现错误时重启服务器，向错误日志文件写入运行时间信息。</li><li>mysql.server：MySQL服务启动服本。调用mysqld_safe来启动MySQL服务。</li><li>mysql_multi：服务器启动脚本，可以启动或停止系统上安装的多个服务。</li><li>myiasmchk：用来描述、检查、优化和维护MyISAM表的实用工具。</li><li>mysqlbu：MySQL缺陷报告脚本。它可以用来向MySQL邮件系统发送缺陷报告。</li><li>mysql_install_db：用于默认权限创建MySQ授权表。通常只是在系统上首次安装MySQL时执行一次。</li></ul><blockquote><p>MySQL客户端工具</p></blockquote><ul><li>mysql：交互式输入SQL语句或从文件以批处理模式执行SQL语句来操作数据库管理系统，就是我们的客户端。</li><li>mysqldump：将MySQL数据库转储到一个文件，可以用来备份数据库。</li><li>mysqladmin：用来检索版本、进程、以及服务器的状态信息。</li><li>mysqlbinlog：用于从二进制日志读取语句。在二进制日志文件中包含执行的语句，可用来帮助系统从崩溃中恢复。</li><li>mysqlcheck：检查、修复、分析以及优化表的表维护。</li><li>mysqlhotcopy：当服务器在运行时，快速备份MyISAM或ISAM表的工具。</li><li>mysql import：使用load data infile将文本文件导入相关表的客户程序。</li><li>perror：显示系统或MySQL错误代码含义的工具。</li><li>myisampack：压缩MyISAP表，产生更小的只读表。</li><li>mysaqlaccess：检查访问主机名、用户名和数据库组合的权限。</li></ul><p>mysql是一个很常用的【mysql客户端工具】，我们可以使用一下命令连接本机或者远程的mysql服务：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"> mysql -h </span><span class="token number" style="color:rgb(247, 140, 108)">124.220</span><span class="token plain">.197.17 -P </span><span class="token number" style="color:rgb(247, 140, 108)">3306</span><span class="token plain"> -uroot -p</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>tips</strong>：我们看到在配置文件中有一个socket的配置，socket 即 Unix 域套接字文件，在类 unix 平台，客户端连接 MySQL 服务端的方式有两种，分别是 TCP/IP 方式与 socket 套接字文件方式。Unix 套接字文件连接的速度比 TCP/IP 快，但是只能连接到同一台计算机上的服务器使用。通过设置 socket 变量可配置套接字文件路径及名称，默认值为 /tmp/mysql.sock。本地客户端的连接默认会使用到该文件：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql -uroot -p -S /tmp/mysql.sock</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果mysql.sock文件误删的话，就需要重启mysql服务</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220507102421872-f0e9cd30.png" alt="image-20220507102421872" class="img_ev3q">image-20220507102421872</p><p>接着给大家介绍一个【数据备份工具】，mysqldump可以用来实现轻量级的【快速迁移或恢复数据库】。 mysqldump是将数据表导成 SQL 脚本文件，在不同的 MySQL 版本之间升级时相对比较合适，这也是最常用的备份方法。mysqldump一般在数据量很小的时候（几个G）可以用于 备份。当数据量比较大的情况下，就不建议用mysqldump工具进行备份了。下边我们简单的使用mysqldump工具进行备份数据，命令如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 备份一个表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysqldump </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">u root </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">p ydlclass ydl_user  </span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">~</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token keyword" style="color:rgb(127, 219, 202)">dump</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 备份一个数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysqldump </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">u root </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">p ydlclass  </span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">~</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token keyword" style="color:rgb(127, 219, 202)">dump</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 备份所有数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysqldump </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">u root </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">p </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">--all-databases &gt; dump.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">备份完成之后使用</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>恢复数据，使用mysql指令：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">u root </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain">p ydl </span><span class="token operator" style="color:rgb(127, 219, 202)">&lt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">~</span><span class="token operator" style="color:rgb(127, 219, 202)">/</span><span class="token keyword" style="color:rgb(127, 219, 202)">dump</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（3）数据库文件，该文件我们同样可以自由指定，该文件夹包含了日志文件，以及我们的数据文件，这些在后边的课程中会详细介绍：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220507112543589-288eb8e4.png" alt="image-20220507112543589" class="img_ev3q">image-20220507112543589</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三字符集和排序规则">三、字符集和排序规则<a href="#三字符集和排序规则" class="hash-link" aria-label="三、字符集和排序规则的直接链接" title="三、字符集和排序规则的直接链接">​</a></h3><p>mysql支持大量的字符集，但是我们通常使用的是utf8，【show collation】命令可以查看mysql支持的所有的排序规则和字符集，如下所示部分：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220427114132237-2a65cd95.png" alt="image-20220427114132237" class="img_ev3q">image-20220427114132237</p><p>由上图可知，一种字符集对应的很多比较规则。</p><p>举个例子：</p><ul><li>utf8-polish-ci，表示utf-8的字符集的波兰语的比较规则，ci代表忽略大小写。</li><li>utf8-general-ci，就是通用的忽略大小写的utf8字符集比较规则。</li><li>utf8mb4_0900_ai_ci中的0900指的是Unicode 9.0的规范，后边的后缀代表不区分重音也不区分大小写，他是utf8mb4字符集一个新的通用排序归则。</li></ul><table><thead><tr><th>后缀</th><th>英文</th><th>描述</th></tr></thead><tbody><tr><td>_ai</td><td>accent insensitive</td><td>不区分重音（è，é，ê和ë）</td></tr><tr><td>_as</td><td>accent sensitive</td><td>区分重音</td></tr><tr><td>_ci</td><td>case insensitive</td><td>不区分大小写</td></tr><tr><td>_cs</td><td>case sensitive</td><td>区分大小写</td></tr><tr><td>_bin</td><td>binary</td><td>以二进制的形式进行比较</td></tr></tbody></table><p>utf8和utf8mb4的区别：</p><ul><li>utf8mb3(utf-8)：使用1~3个字节表示字符，utf8默认就是utf8mb3。</li><li>utf8mb4：使用1~4个字节表示字符，他是utf8的超集，甚至可以存储很多【emoji表情😀😃😄😁😆】，mysql8.0已经默认字符集设置为utf8mb4。</li></ul><p>【字符集】和【比较规则】可以作用在全局、数据库、表、甚至是列级别：</p><p>全局：</p><p>mysql提供两个变量，进行全局设置。【character_set_server】和【collate_server】对全局的字符集和排序规则进行设置。这两个设置可以在配置文件中修改。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220427160641490-e72633a5.png" alt="image-20220427160641490" class="img_ev3q">image-20220427160641490</p><p>在创建表时，可以对数据库、表、列指定字符集和排序规则：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 指定数据库</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">database</span><span class="token plain"> 数据库名 </span><span class="token keyword" style="color:rgb(127, 219, 202)">character</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> 字符集  </span><span class="token keyword" style="color:rgb(127, 219, 202)">collate</span><span class="token plain"> 比较规则</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- </span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">table</span><span class="token plain"> 表名</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    列名 列类型 </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">character</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> 字符集 </span><span class="token keyword" style="color:rgb(127, 219, 202)">collate</span><span class="token plain"> 比较规则</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">table</span><span class="token plain"> 表名</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    列名 列类型 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">character</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> 字符集</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token keyword" style="color:rgb(127, 219, 202)">collate</span><span class="token plain"> 比较规则</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四mysql修改配置的方法">四、mysql修改配置的方法<a href="#四mysql修改配置的方法" class="hash-link" aria-label="四、mysql修改配置的方法的直接链接" title="四、mysql修改配置的方法的直接链接">​</a></h3><p>在mysql中变量分为全局变量和会话变量，我们一一讲解：</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1全局变量">1、全局变量<a href="#1全局变量" class="hash-link" aria-label="1、全局变量的直接链接" title="1、全局变量的直接链接">​</a></h4><p>（1）查看全局变量</p><p>我们查看一个全局变量wait_timeout的值（这个值代表，客户端和服务器的连接不生交互后多久自动断开连接），语法如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">global</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;%wait_timeout%&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@global.wait_timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（2）设置全局变量方法1，修改配置文件, 然后重启mysqld：</p><div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain"># vi /etc/my.cnf</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">wait_timeout=10000</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"># service mysqld restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（3）设置全局变量方法2（推荐），在命令行里通过SET来设置：</p><p>如果要修改全局变量, 必须要显示指定&quot;GLOBAL&quot;或者&quot;@@global.&quot;，同时必须要有SUPER权限.：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">global</span><span class="token plain"> wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@global.wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后查看设置是否成功:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">global</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;wait_timeout&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@global.wait_timeout</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2当前会话的变量">2、当前会话的变量<a href="#2当前会话的变量" class="hash-link" aria-label="2、当前会话的变量的直接链接" title="2、当前会话的变量的直接链接">​</a></h4><p>如果要修改会话变量值, 可以指定&quot;SESSION&quot;或者&quot;@@session.&quot;或者&quot;@@&quot;或者&quot;LOCAL&quot;或者&quot;@@local.&quot;, 或者什么都不使用。语法语法：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">local</span><span class="token plain"> wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@session.wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@local.wait_timeout</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后查看设置是否成功:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@wait_timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@session.wait_timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@local.wait_timeout</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;wait_timeout&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">local</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;wait_timeout&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">mysql</span><span class="token operator" style="color:rgb(127, 219, 202)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;wait_timeout&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="五内置数据库">五、内置数据库<a href="#五内置数据库" class="hash-link" aria-label="五、内置数据库的直接链接" title="五、内置数据库的直接链接">​</a></h3><ul><li>mysql：这个库很重要，他是mysql的核心数据库，负责存储数据库的用户、权限设置、关键字等mysql自己需要使用，控制和管理的信息。</li><li>information_schema：这个数据库维护了数据库其他表的一些描述性信息，也称为元数据。比如，当前有哪些表，哪些视图，哪些触发器，哪些列等。</li><li>performation_schema：这个数据库用来存储mysql服务器运行过程中的一些状态信息，是做性能监控的。比如最近执行了什么sql语句，内存使用情况等</li><li>sys：结合information_schema和performation_schema的数据，能更方便的了解mysql服务器的性能信息。</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第二章-io和存储">第二章 I/O和存储<a href="#第二章-io和存储" class="hash-link" aria-label="第二章 I/O和存储的直接链接" title="第二章 I/O和存储的直接链接">​</a></h2><p><strong>谈谈性能：</strong>mysql通常决定了一个系统的性能瓶颈，执行一条sql的成本主要在于以下两个方面：</p><ul><li>I/O成本：我们经常使用的MyIsam和InnoDB存储引擎都是将数据存储在磁盘上，当查询表中的记录时，需要先将数据加载到内存中，然后进行操作，这个从磁盘到内存的加载过程损耗的时间成为I/O成本。</li><li>CPU成本：读取记录以及检测记录是否满足对应的搜索条件、对结果集进行排序等这些操作所消耗的时间称之为CPU成本。</li></ul><p>本章节我们聊一聊I/O成本。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一io成本">一、IO成本<a href="#一io成本" class="hash-link" aria-label="一、IO成本的直接链接" title="一、IO成本的直接链接">​</a></h3><p>我们想想要了解mysql的I/O成本，就需要知道计算机的磁盘是怎么工作的。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1磁盘的结构">1、磁盘的结构<a href="#1磁盘的结构" class="hash-link" aria-label="1、磁盘的结构的直接链接" title="1、磁盘的结构的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20201122150129276-837e618f.png" alt="image-20201122150129276" class="img_ev3q"></p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1盘片片面和磁头">（1）盘片、片面和磁头<a href="#1盘片片面和磁头" class="hash-link" aria-label="（1）盘片、片面和磁头的直接链接" title="（1）盘片、片面和磁头的直接链接">​</a></h5><p>硬盘中一般会有多个【盘片】组成，每个盘片包含【两个面】，每个盘面都对应的有一个【读/写磁头】。受到硬盘整体体积和生产成本的限制，盘片数量都受到限制，一般都在5片以内。盘片的编号【自下向上】从0开始，如最下边的盘片有0面和1面，再上一个盘片就编号为2面和3面。</p><p>结构示意图，如图：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195930213-55095177.png" alt="image-20220424195930213" class="img_ev3q">image-20220424195930213</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2扇区和磁道">（2）扇区和磁道<a href="#2扇区和磁道" class="hash-link" aria-label="（2）扇区和磁道的直接链接" title="（2）扇区和磁道的直接链接">​</a></h5><p>下图显示的是一个盘面，盘面中一圈圈灰色同心圆为一条条磁道，从圆心向外画直线，可以将磁道划分为若干个弧段，每个磁道上一个弧段被称之为一个扇区（图践绿色部分）。扇区是磁盘的最小组成单元，通常是512字节。（由于不断提高磁盘的大小，部分厂商设定每个扇区的大小是4096字节）；</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220424195949755-9516f689.png" alt="image-20220424195949755" class="img_ev3q">image-20220424195949755</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3磁头和柱面">（3）磁头和柱面<a href="#3磁头和柱面" class="hash-link" aria-label="（3）磁头和柱面的直接链接" title="（3）磁头和柱面的直接链接">​</a></h5><p>硬盘通常由重叠的一组盘片构成，每个盘面都被划分为数目相等的磁道，并从外缘的“0”开始编号，具有相同编号的磁道形成一个圆柱，称之为磁盘的柱面。磁盘的柱面数与一个盘面上的磁道数是相等的。由于每个盘面都有自己的磁头，因此，盘面数等于总的磁头数。 如下图</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220425153537739-a5e991d6.png" alt="image-20220425153537739" class="img_ev3q">image-20220425153537739</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2磁盘容量计算">2、磁盘容量计算<a href="#2磁盘容量计算" class="hash-link" aria-label="2、磁盘容量计算的直接链接" title="2、磁盘容量计算的直接链接">​</a></h4><p>存储容量 ＝ 磁头数 × 磁道(柱面)数 × 每道扇区数 × 每扇区字节数</p><p>图3中磁盘是一个 3个圆盘6个磁头，7个柱面（每个盘片7个磁道） 的磁盘，图3中每条磁道有12个扇区，所以此磁盘的容量为：</p><p>存储容量 6 <em> 7 </em> 12 * 512 = 258048</p><p><strong>tips：</strong>有些【古老硬盘】每个磁道的扇区数一样，外圈的密度小，内圈的密度大，每圈可存储的数据量是一样的。现在的硬盘数据的密度都一致，这样磁道的周长越长，扇区就越多，存储的数据量就越大。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3磁盘读取响应时间">3、磁盘读取响应时间<a href="#3磁盘读取响应时间" class="hash-link" aria-label="3、磁盘读取响应时间的直接链接" title="3、磁盘读取响应时间的直接链接">​</a></h4><ol><li>寻道时间：磁头从开始移动到数据所在磁道所需要的时间，寻道时间越短，I/O操作越快，目前磁盘的平均寻道时间一般在3－15ms，一般都在10ms左右。</li><li>旋转延迟：盘片旋转将请求数据所在扇区移至读写磁头下方所需要的时间，旋转延迟取决于磁盘转速。普通硬盘一般都是7200rpm，大概一圈8ms，慢的5400rpm。</li><li>数据传输时间：完成传输所请求的数据所需要的时间。 小结一下：从上面的指标来看、其实最重要的、或者说、我们最关心的应该只有两个：寻道时间；旋转延迟。</li></ol><p>读写一次磁盘信息所需的时间可分解为：寻道时间、延迟时间、传输时间。为提高磁盘传输效率，软件程序应着重考虑减少寻道时间和延迟时间。</p><p>下图是计算机硬件延迟的对比图，供大家参考：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220425153556197-aef612b3.png" alt="image-20220425153556197" class="img_ev3q">image-20220425153556197</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4交换单位">4、交换单位<a href="#4交换单位" class="hash-link" aria-label="4、交换单位的直接链接" title="4、交换单位的直接链接">​</a></h4><p>【块】是操作系统中最小的逻辑存储单位，他是虚拟出来的一个单位。操作系统与磁盘打交道的最小单位是磁盘块。每个块可以包括2、4、8、16、32、64…2的n次方个扇区。</p><p><strong>为什么存在磁盘块？</strong></p><ul><li>读取方便：由于扇区的容量比较小，数目众多，在寻址时比较困难，所以操作系统就将相邻的扇区组合在一起，形成一个块，再对块进行整体的操作。</li><li>分离对底层的依赖：操作系统忽略对底层物理存储结构的设计。通过虚拟出来磁盘块的概念，在系统中认为块是最小的单位。</li></ul><p><strong>扇区、块/簇、page的关系：</strong></p><ol><li>扇区： 硬盘的最小读写单元</li><li>块/簇： 是操作系统针对硬盘读写的最小单元</li><li>page： 是内存与操作系统之间操作的最小单元</li></ol><p>扇区 &lt;= 块/簇 &lt;= page</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5局部性原理与磁盘预读">5、局部性原理与磁盘预读<a href="#5局部性原理与磁盘预读" class="hash-link" aria-label="5、局部性原理与磁盘预读的直接链接" title="5、局部性原理与磁盘预读的直接链接">​</a></h4><p>由于存储介质的特性，磁盘本身存取就【比主存慢很多】，再加上机械运动耗费，磁盘的存取速度往往是主存的【十万分之一】，因此为了提高效率，要【尽量减少磁盘I/O】。也是因为这个原因，磁盘往往不是严格的【按需读取】，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。这样做的理论依据是计算机科学中著名的<strong>局部性原理</strong>。</p><p><strong>局部性原理：</strong>当一个数据被用到时，其附近的数据也通常会马上被使用，程序运行期间所需要的数据通常比较集中。</p><p>由于磁盘【顺序读取】的效率很高（不需要寻道时间，只需很少的旋转时间），因此对于具有局部性的程序来说，预读可以提高I/O效率。</p><p>预读的长度一般为【页（page）】的整倍数（在许多操作系统中，页得大小通常为4k）。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二数据存储">二、数据存储<a href="#二数据存储" class="hash-link" aria-label="二、数据存储的直接链接" title="二、数据存储的直接链接">​</a></h3><p>对于mysql而言，数据是存储在文件系统中的，不同的存储存储引擎会有不同的文件格式和组织形式，我们还是以innodb为例给大家讲解。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1innodb数据存储">1、innodb数据存储<a href="#1innodb数据存储" class="hash-link" aria-label="1、innodb数据存储的直接链接" title="1、innodb数据存储的直接链接">​</a></h4><p>对于innodb而言，数据是存储在表空间（文件空间file space）内的，表空间是一个抽象的概念，他对应着硬盘上的一个或多个文件，如下图：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220427104757135-00dc235b.png" alt="image-20220427104757135" class="img_ev3q">image-20220427104757135</p><p>表空间存储数据的单位是【页】，我们可以这样类比，一个表空间就是个大大的本子，本子里是一页页的数据（innodb是以页为单位进行数据存储的），常用页面类型有很多，不同类型的页面可以存放【不同类型的数据】，这里不展开讲解，暂时统称为【数据页】、他的通用部分如下，每一页大概占用16k的空间：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220426220208824-0063a836.png" alt="image-20220426220208824" class="img_ev3q">image-20220426220208824</p><ul><li>file header：记录页面的一些通用信息，比如当前页的校验和、页号、上页号、下页号、所属表空间等。</li><li>file trailer：主要的工作是检验页是否完整。</li><li>表空间中的每一个页，都有一个页号（File_PAGE_OFFSET），我们可以通过这个页号在表空间快速定位到指定的页面。这个页号由4个字节组成，也就是32位，所有最多能存放2的32次方页，如果按照一页16k计算，一个表空间最大支持【64TB】的数据。整体的排列中页是连续的，但是页有上下指针，不连续的页也能组成链表。</li></ul><p>表空间的示意图如下：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220427154308986-93b2bedb.png" alt="image-20220427154308986" class="img_ev3q">image-20220427154308986</p><p>表空间可以分为系统表空间、独立表空间等：</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1系统表空间the-system-tablespace">（1）系统表空间（The System Tablespace）<a href="#1系统表空间the-system-tablespace" class="hash-link" aria-label="（1）系统表空间（The System Tablespace）的直接链接" title="（1）系统表空间（The System Tablespace）的直接链接">​</a></h5><ul><li>系统表空间包含了很多【公共数据】，比如InnoDB的数据字典，回滚信息、系统事物信息、二次写缓冲等，老版本的mysql表中的数据也会存储在系统表空间。</li><li>系统表空间是一个共享的表空间因为它是被多个表共享的。</li><li>该空间的数据文件通过参数【innodb_data_file_path】控制，默认值是<code>ibdata1:12M:autoextend</code>（文件名为ibdata1、12MB、自动扩展）。</li><li>当然系统表空间也可以通过配置，修改文件的名称和个数。文件如下图：</li></ul><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220427181352706-d43290e2.png" alt="image-20220427181352706" class="img_ev3q">image-20220427181352706</p><p>相关变量的设置：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 如果1代表开启，0代表关闭</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;innodb_file_per_table&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 设置对应的变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">global</span><span class="token plain"> innodb_file_per_table</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 查看系统表空间的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&quot;innodb_data_file_path&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 配置文件的配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">innodb_data_file_path</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">data1:</span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain">M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">data2:</span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain">M:autoextend</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2独立表空间file-per-table-tablespaces">（2）独立表空间（File-Per-Table Tablespaces）<a href="#2独立表空间file-per-table-tablespaces" class="hash-link" aria-label="（2）独立表空间（File-Per-Table Tablespaces）的直接链接" title="（2）独立表空间（File-Per-Table Tablespaces）的直接链接">​</a></h5><ul><li>独立表空间是默认开启的，在5.6.6以后，Innodb不在默认将各个表的数据存储在【系统表空间】当中，而是会为每一个表建立一个独立表空间，innodb存储引擎的独立表空间为【.ibd】文件。</li><li>如果启用了【innodb_file_per_table】参数，需要注意的是每张表的表空间内存放的只是【数据】、【索引】和【插入缓冲Bitmap页】，其他数据如：回滚信息、系统事物信息、二次写缓冲（Double write buffer）等还是放在原来的系统表空间内。</li><li>同时说明了一个问题：即使启用了【innodb_file_per_table】参数，系统表空间还是会不断的增加其大小的。</li></ul><p><img loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA68AAAAtCAYAAABBCF2nAAAKI0lEQVR4nO3dQUwj1x3H8Z+jSFVPzfZi7DPbQxR5hX2DuwWOD3tatYoiF8kyt4Gq2tZaNoqi4K0jLjCq2i5FSqwoF04cvDbyPdyMxSjqIXC2mUtQT1WlKu5hxvYY7LENBgb4fiQkPO/Ne2/GM2j+/OfNhNrtdlsAMKFms6loNHrXw8A9xfHzsPH9Xg/7DwAGe++uBwAAAAAAwCgErwAAAACAwCN4BQAAAAAEHsErAAAAACDwCF4BAAAAAIEX4mnDAAAAAICgI/MKAAAAAAg8glcAAAAAQOARvAIAAAAAAo/gFQAAAAAQeASvAAAAAIDAI3gFAAAAAAQewSsAAAAAIPAIXgEAAAAAgUfwCgAAAAAIPIJXAAAAAEDgvT/tBje/+ovOz38aWv7kya/1yacZRaPRaXcNAAAAAHigph68np//pC++fDO0/PPPXum7b7/RJ5/+ngAWAAAAADCWO7lt+Le/+0TfffuNms3mXXQPAAAAALhnbj14/eCDD/T3v/1V5+fn2v3nP6bTaHVFoYVtnToftBJaUXU6Ld+s020thBa0fSpJp9peCGllkoH3bTcA4Ops1YqGStaIalZJxZp9aZkxckUAAHBdU79teJQ//PFP3d8//+zVbXcP4LZYJRm7dfdDVOn1vJLhbqFKxq7qg8r81vNt02XXVCy0lDIzinn6aqXXlb9U+UL9scecULbb/tAdMLzfvn6GtDVyW0ds1z1nlQxVIr1ts0qGurtDkqJpreeTckpt1YoFlftu5hnnO/IKK5nPqmQUVRt0XHXG1WgpvtgZU1Fni3klJ9gu3Da/82RI2Th/Z7pVDTXmTGU6B5pdU7FQVjORlZmJjThuAQCTuvXgFR6zq/q+vXrXowBugKVSJaJ103Qu0qySjEJJM2ZGMdmqFZ0LRjMZvlDmt55fWY99fCSll91+Cio3E0okho+0V3/UmBuaM01l5AZSpTmZmUGh0Yh+rZIMbz9X2n+jt+shiqb7g9lCaabvO0hkPUGEVZJhGP3LugYFux4FQ+X+jp2Aw66p0opr2flS1GjFtRiWZA9sBXfK7zzxKxvv78xglkqFsiJZU3lP5VHHLQBgfASvAG5ATBnv1VtsTglVdGZLMR3rqJlQKu+GbrFFpaMFNayMYjGf9cJ+ZZ2Flg7KUnzdWZDMm0pKskp1tQaO01s/7NN+WMl8xlOUkCpnshUbEICGffq1Vau0lF7OjMi8+G2rX/uPRzgSle/GxzIy1yMqFkqyLgUevX1o14o6mMlfDnCtkopni30ZOfv4SM1Iyg1qGqo366obnTC3LsPNsEUfaDb8fvE7T/zKxvk7M4gni+sTl448bgEAvgL7ntfthZAWtj2zOS/Naw0p1PlJ7UzQclUroQVtV7e14K6/UnXbdz/39Xuhr16Z2872gPVOt7XgnXd78bPv8v7++ufAXme7gTtkNVRXRDNhSXZLzcScJ5gIayYitc4GpK+8641TZjVUj8b1bNy4wa++T99Wo65o/Nnkt/7ZxzpSXDowZBjOT3f+pF1T0Sjq4nTKUWN5nGwdHzWVmBuRvQo/UzxaV8NnOmr4WVytARWsRkvxvgPD0kE3Vev+E2LdlGmaMrMJKZF1fjdNAteHZKxzr3c3if93P+ZxCwAYKrDB6+rrnA733nUfRlTd31Hu9apmVdVKKCVV2mq3nZ9KbtLWD7W2IZXabbUrOe2kQgrtP3faO9mS1jbdgLKqldCGPjzp9HWiF3tPPQHlodb+5V0vo+1rPj1pJ7Wv5+52OWNb8YzlutsN3AG7puJuXYmsk/2yz8ZMO1xYb5wyq1FXIjX+fLKh9Qe1b9dUdAPOxtwVAxS7pWazrNacG/Ssp6Xy14MDVr+xPFLNcsEN+gsqK63FaeyQ8DPFW5X+78C9Pdgbu9q1ilqJhKKS80+ISGroPEg8EGOee/Vd53hcHnJA3MhxCwCPVGCDVy09V+5wT+9OJamq/Z2cni9Jqu5rZ35LL5e8VSeN4ua1VVrVbKcfzWur0+Dsb/SRftCPp25fOtTa006286nWDqUffjzttdNd72O9mL/65nbkKm/V3bSll9qa39F+VVPabuB22bWijMKR4uu9eYfhmciV1htZZtdUqSc0dlJjSP2h7YeTyruZtbmGIaNYu9pUx6jn4jWcVCrR1NGx7bbf/2AYv/3wGEXT693spplqqWCUNPoZv1FFfIPMsJLLcR193fk+LZUKR4ov9/9Tw1Zcy4vusRtOKs8X8qBNcu4lsqaykbIKQ/4mXO24BQAMEuA5r0t6ubWhzLtTfawN7eRe6+1dDGN+Syffu4Fun5M7GAxwf1glQ7vKyjQHXPm1vPNFbZ21pMhceOR6fmX28ZGaidTY2clB9X3H7BHLZJUwKjq2k5Nl38IRJ3M3hnHH8miNMxfROlBZca2P+o7CSeVTzgOehj1dNpZMSnbNbdf7NNqO3pxXnih7v13l3Itl1pUuFkY/jGnsObQAgEGCm3mVNPvxC2lvU5t76mU4l54rd7imzd6EUm1v3NDcz0t9SdWVcd8h62ZvJZ2+29NhZ3Hfu10v29nvtX66ndHaoZtxvs3tBq7LzWpmB13ExRaVVlkHndSDddC7lc5vPb+yieeSDag/ou+i5z2edq0y2dzajvAzxVXW1555rpV61Jlb6Z3z6rutkDR6LqJVkrHbUnp50iCyqdaolHos08ukDZjzahK43l9XPvecVy0l6rv+7/xl/joAXEuAM6+SZlf1+qOQUj9s6aSb+lzS20pOoVRITug2r62tnLR3EwNY0tuTLS08DSnkLslV2qMzwLOrKm3t6enTkNYkzedyGveO4pz2FQqlup8q7c5txLe53cA12S01Vdeu0Z+dcl5bElZyOa1iwZDhLFXWdC/2/daTT1n4WEdKa3n8tOvl+r5jTmo5UpRh7HaW9sY8EecCt2UU1HlIbSJrOlm+vjmXfmOZuNMHo1nu7bdB73Gt7xrq7rFoWuvmqKc6e94fm8jKNDPdZcYuTw1+lK517sWUMbOSsSuj5WTfpdHHLQBgfKF2u92eZoOv8i/1xZdvxqr7+Wev9Ka46VunuhLSxocn+n718o27ACA5wUYlMn6gMWl9PDS997z6BSV2rahCudn3ntfiwczl+a5WSUZj2Ht/AQDAtAQ783q6rY2dnF63CVwBDGOpUY923+06/fp4eHrv+fStlczLTPYtkOd1vz2xjJiaDADAzZt65nXzqzc6Pz8fq+6TJ0/08s+vBpZVV0JK7bi36S4NrDKC82qZi7NCr94eAAAAAOCuTD14BQAAAABg2gL9tGEAAAAAACSCVwAAAADAPUDwCgAAAAAIPIJXAAAAAEDgEbwCAAAAAAKP4BUAAAAAEHgErwAAAACAwCN4BQAAAAAEHsErAAAAACDw3r/qiv/5n/Tv/0o/t6c5HAAAgMfjvZD0q19Iv7zyFRkAPB5XzrwSuAIAAFzPz23nmgoAMNr/AVIyCC8o3UQ7AAAAAElFTkSuQmCC" alt="image-20220427163520350" class="img_ev3q">image-20220427163520350</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3其他类型的表空间">（3）其他类型的表空间，<a href="#3其他类型的表空间" class="hash-link" aria-label="（3）其他类型的表空间，的直接链接" title="（3）其他类型的表空间，的直接链接">​</a></h5><p>除了以上两种表空间，，innodb还提供了很多其他类型的表空间，比如通用表空间，undolog表空间、临时表空间等，这里不在赘述。</p><p><strong>tips：</strong>MyIsam数据存储</p><p>MyIsam没有表空间的概念，他会在目录中产生2个文件【.MYD】（数据文件）、【 .MYI】（索引文件）三个文件。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220427164333413-20982ce1.png" alt="image-20220427164333413" class="img_ev3q">image-20220427164333413</p><p><strong>注意：</strong>在5.7以前【数据文件】和【表信息文件】是分开的，相互独立的。会多一个【.frm】文件，8.0之后进行了合并。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2组织结构">2、组织结构<a href="#2组织结构" class="hash-link" aria-label="2、组织结构的直接链接" title="2、组织结构的直接链接">​</a></h4><ul><li>区（extent）：：每一个表空间保存了大量的页，为了更好的管理这些页面，Innodb提出了【区】的概念，对于16k的页，连续64个页就是一个区，大概1M的空间，每一个表空间都是由若干个连续的区组成的，每256个区被划分为一组。</li><li>段（Segment）：分为索引段，数据段，回滚段等后边会将，段是为了区分不同的数据类型，相同的段存的数据类型是一致的。一个段包含256个区(256M大小)。</li></ul><p>inndb表空间结构如下图所示：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142327089-786fc468.png" alt="image-20220505142327089" class="img_ev3q">image-20220505142327089</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2row-format行记录格式">2、Row Format(行记录格式)<a href="#2row-format行记录格式" class="hash-link" aria-label="2、Row Format(行记录格式)的直接链接" title="2、Row Format(行记录格式)的直接链接">​</a></h4><ul><li>一个表的【行记录格式】决定表中行的【物理存储模式】，决定了【DQL】和【DML】的操作性能。越多的行被匹配进独立的磁盘页，sql的性能会更好一些，需要的缓存及io操作就越少。</li><li>一条完整的信息记录分为：【记录的额外信息】和【记录的真实数据】两大部分，就如同一箱苹果里的苹果分为包装和苹果一样。</li><li>我们可以通过命令<code>SHOW TABLE STATUS LIKE &#x27;table_name&#x27;</code>来查看当前表使用的行格式，其中row_format就代表了当前使用的行记录结构类型。</li></ul><p>指定行格式的语法如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 创建数据表时,显示指定行格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">TABLE</span><span class="token plain"> 表名 </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">列的信息</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> ROW_FORMAT</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">行格式名称</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 创建数据表时,修改行格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">TABLE</span><span class="token plain"> 表名 ROW_FORMAT</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">行格式名称</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 具体如下：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token identifier">ydl_user</span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">bigint</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">AUTO_INCREMENT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;用户ID&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token identifier">user_name</span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">varchar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">30</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">CHARACTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> utf8mb4 </span><span class="token keyword" style="color:rgb(127, 219, 202)">COLLATE</span><span class="token plain"> utf8mb4_0900_ai_ci </span><span class="token operator" style="color:rgb(127, 219, 202)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;用户账号&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token identifier">user_id</span><span class="token identifier punctuation" style="color:rgb(199, 146, 234)">`</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">USING</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">BTREE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> ROW_FORMAT </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> DYNAMIC</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1compact"><strong>（1）COMPACT</strong><a href="#1compact" class="hash-link" aria-label="1compact的直接链接" title="1compact的直接链接">​</a></h5><p>【compact行记录】是在MySQL 5.0时被引入的，其设计目标是能高效存放数据。Compact行记录以如下方式进行存储：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142826773-83792245.png" alt="image-20220505142826773" class="img_ev3q">image-20220505142826773</p><ul><li>第一个部分是一个非NULL【变长字段长度列表】。这个其实很好理解，我们的数据类型除了定长的char、int还有不定长的如varchar、text等，变长列的真实长度就保存在这个部分，他是按照列的顺序【逆序放置】的。当列的长度小于255字节，如（varchar(50)），用1字节表示；若大于255个字节（varchar(600)），用2个字节表示，这其实也就说明了为什么<strong>varchar的最大长度是65536</strong>。</li><li>第二个部分是【NULL标志位】，他指示了当前行数据中哪些为null值，用一个bitmap表示。举一个例子：假如该标志位为06(二进制：00000110)则表示第二三列（可以为空的列）的数据为NULL。需要注意的是，NULL值标志位仅仅针对可以为【NULL的字段】，如果某个字段被定义为not null，那么这个字段就不会进入NULL值标志位的BitMap中，这样可以节省很多空间，NULL值标志位也是逆序排列，占用空间按照字节数高位补零，如有九个字段可以为空（00000001 01010101）。</li><li>第三部分为记录头信息（record header），固定占用5个字节（40位），每位的含义见下表：</li></ul><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142851556-e87bd07f.png" alt="image-20220505142851556" class="img_ev3q">image-20220505142851556</p><ul><li><p>第四部分就是实际存储的每个列的数据了，需要特别注意的是，NULL不占该部分任何数据，即NULL除了占有NULL标志位，实际存储不占有任何空间。Innodb存储变长列（VARCHAR, VARBINARY, BLOB, TEXT）的前768字节，剩下的部分存储在溢出页中。固定长度列，超过768字节的视为变长列。内部存储前768字节，20字节指针存储列的溢出页的地址，所以长度为768+20字节。</p><p>  <img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505181612836-38c0d037.png" alt="image-20220505181612836" class="img_ev3q">image-20220505181612836</p></li></ul><p><strong>注意：</strong>另外有一点需要注意的是，每行数据除了用户定义的列外，<strong>还有两个隐藏列，事务ID列和回滚指针列</strong>，分别为6个字节和7个字节的大小。若InnoDB表没有定义Primary Key，每行还会增加一个【6字节的RowID列】。</p><p><strong>例子：</strong>我们不妨举一个例子，看看硬盘的存储格式，以下表为准：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">table</span><span class="token plain"> test </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">　　t1 </span><span class="token keyword" style="color:rgb(127, 219, 202)">varchar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">　　t2 </span><span class="token keyword" style="color:rgb(127, 219, 202)">varchar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">　　t3 </span><span class="token keyword" style="color:rgb(127, 219, 202)">char</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">　　t4 </span><span class="token keyword" style="color:rgb(127, 219, 202)">varchar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">engine</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token keyword" style="color:rgb(127, 219, 202)">innodb</span><span class="token plain"> row_format</span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain">compact</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> row_test </span><span class="token keyword" style="color:rgb(127, 219, 202)">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;a&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;bb&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;bb&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ccc&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> row_test </span><span class="token keyword" style="color:rgb(127, 219, 202)">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;d&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ee&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ee&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;fff&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> row_test </span><span class="token keyword" style="color:rgb(127, 219, 202)">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;d&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;fff&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>节选对应的【真实的表空间】中的的二进制结构表示：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">                         03 02 01 00 00 00 </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> 00 </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">2c 00 00 00 00 2b </span><span class="token number" style="color:rgb(247, 140, 108)">68</span><span class="token plain"> 00  00 00 00 06 05 </span><span class="token number" style="color:rgb(247, 140, 108)">80</span><span class="token plain"> 00 00 </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 </span><span class="token number" style="color:rgb(247, 140, 108)">32</span><span class="token plain"> 01 </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">61</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">62</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">62</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">62</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">62</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">63</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">63</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">63</span><span class="token plain"> 03 02 01 00  00 00 </span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"> 00 2b 00 00 00  </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 02 01 00 00 00 00 0f  </span><span class="token number" style="color:rgb(247, 140, 108)">62</span><span class="token plain"> c9 00 00 01 b2 01 </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain">  </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">03 01 06 00 00 </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> ff </span><span class="token number" style="color:rgb(247, 140, 108)">98</span><span class="token plain">  00 00 00 00 02 02 00 00 </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 0f </span><span class="token number" style="color:rgb(247, 140, 108)">67</span><span class="token plain"> cc 00 00 01  b6 01 </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一行整理如下，需要注意，我们有三个变长列varchar：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">03 02 01 // 变长字段长度列表，逆序，t4列长度为3，t2列长度为2，t1列长度为1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 // NULL标志位，第一行没有NULL值</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 10 00 2c // 记录头信息，固定5字节长度</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 00 00 2b 68 // RowID我们建的表没有主键，因此会有RowID，固定6字节长度</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 00 00 06 05 // 事务ID，固定6个字节</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">80 00 00 00 32 01 10 // 回滚指针，固定7个字节</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">61 // t1数据&#x27;a&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">62 62 // t2&#x27;bb&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">62 62 20 20 20 20 20 20 20 20 // t3数据&#x27;bb&#x27;  Ox20十进制是32对应ascii码是空字符</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">63 63 63 // t4数据&#x27;ccc&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二行整理如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">03 02 01 // 变长字段长度列表，逆序，t4列长度为3，t2列长度为2，t1列长度为1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 // NULL标志位，第二行没有NULL值</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 </span><span class="token number" style="color:rgb(247, 140, 108)">18</span><span class="token plain"> 00 2b // 记录头信息，固定5字节长度</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 00 00 02 01 // RowID我们建的表没有主键，因此会有RowID，固定6字节长度</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 00 00 0f </span><span class="token number" style="color:rgb(247, 140, 108)">62</span><span class="token plain"> // 事务ID，固定6个字节</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">c9 00 00 01 b2 01 </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> // 回滚指针，固定7个字节</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">64</span><span class="token plain"> // t1数据</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;d&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> // t2数据</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ee&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">65</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token plain"> // t3数据</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;ee&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">66</span><span class="token plain"> // t4数据</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;fff&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三行整理如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">03 01 // 变长字段长度列表，逆序，t4列长度为3，t1列长度为1</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">06 // 00000110 NULL标志位，t2和t3列为空</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 20 ff 98  // 记录头信息，固定5字节长度</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 00 00 02 02 // RowID我们建的表没有主键，因此会有RowID，固定6字节长度</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">00 00 00 00 0f 67 // 事务ID，固定6个字节</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">cc 00 00 01 b6 01 10 // 回滚指针，固定7个字节</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">64 // t1数据&#x27;d&#x27;</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">66 66 66 // t4数据&#x27;fff&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2redundant">（2）REDUNDANT<a href="#2redundant" class="hash-link" aria-label="（2）REDUNDANT的直接链接" title="（2）REDUNDANT的直接链接">​</a></h5><p>【Redundant】是MySQL 5.0版本之前InnoDB的行记录存储方式。Redundant行记录以如下方式存储：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142609716-f073d2f3.png" alt="image-20220505142609716" class="img_ev3q">image-20220505142609716</p><p>从上图可以看到，Redundant行格式如下：</p><ol><li><p>第一个部分保存了【字段长度偏移列表】，这个部分保存了该行数据所有列，包括隐藏列的长度偏移量。举一个例子说明一下偏移，假如第一个字段长度为x，第二个字段长度为y，那么列表中第一个字段就是x，第二个字段就是x+y。这个偏移列表是按照列的顺序【逆序排列】。</p></li><li><p>第二个部分为记录头信息【record header】，Redundant行格式固定占用6个字节（48位），每位的含义如下图：</p><p>有几个标志位我们可以注意一下，<code>n_fields</code>值代表一行中列的数量，占用10位，这也很好地解释了为什么MySQL【一个行支持最多的列为1023】。</p></li></ol><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505142646478-14643b59.png" alt="image-20220505142646478" class="img_ev3q">image-20220505142646478</p><p> 3.第三个部分就是实际存储的每个列的数据了。</p><p><strong>null值的存储</strong>，在【字段长度列表】的每个字段长度最高位标记 1 表示这个字段为 NULL。</p><ul><li>对于一字节存储，通过【最高位标记字段】判断是否为 NULL，如果为 NULL，则最高位为1，否则为0。剩下的 7 位用来存储数据，所以最多是127。</li><li>对于两字节存储，通过【最高位标记字段】判断是否为 NULL，第二位标记这条记录是否在同一页，如果在则为0，如果不在则为1，这其实就涉及到了后面要说的溢出页。剩下的 14 位表示长度，所以最多是16383。</li><li>在这种类型的行格式中，无论字段是否为 NULL，或者长度是多少，<strong>char(M) 都会占用 M <!-- -->*<!-- --> 字节编码最大长度那么多字节</strong>。为 NULL 的话，填充的是 0x00，不为 NULL，长度不够的情况下，末尾补充 0x20。 对于varchar来说，NULL 还是不占用空间的。</li></ul><p><strong>小结：</strong></p><p>compact格式比redundant存储空间大约减少20%。如果受限于cache命中和磁盘速度，compact格式会快一些，若受限于CPU速度，compact格式会慢一些。</p><p><strong>（3）DYNAMIC</strong></p><p>InnoDB Plugin引入了两种新的文件格式（file format，可以理解为新的页格式），对于以前支持的Compact和Redundant格式将其称为Antelope文件格式，新的文件格式称为Barracuda。Barracuda文件格式下拥有两种新的行记录格式Compressed和Dynamic两种。</p><p>新的两种格式对于存放BLOB的数据采用了完全的行溢出的方式，在数据页中只存放20个字节的指针，实际的数据都存放在BLOB Page中，而之前的Compact和Redundant两种格式会存放768个前缀字节。mysql8.0默认此格式。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220505154503535-312b70d6.png" alt="image-20220505154503535" class="img_ev3q">image-20220505154503535</p><p><strong>（4）COMPRESSED</strong> 基于dynamic格式，支持表和索引数据压缩。compressed行格式采用dynamic相同的页外存储细节，同时，存储在其中的行数据会以zlib的算法进行压缩，因此对于BLOB、TEXT、VARCHAR这类大长度类型的数据能进行非常有效的存储。</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第三章-缓冲池-buffer-pool">第三章 缓冲池 buffer pool<a href="#第三章-缓冲池-buffer-pool" class="hash-link" aria-label="第三章 缓冲池 buffer pool的直接链接" title="第三章 缓冲池 buffer pool的直接链接">​</a></h2><p>我们在之前的章节中已经介绍过了，innodb中的数据是以【页】的形式存储在磁盘上的表空间内，但是我们一再强调过，【磁盘的速度】和【内存】相比简直不值一提，而【内存的速度】和【cpu的速度】同样不可同日而语，对于数据库而言，I/O成本永远是不可忽略的一项成本，我们不妨思考下面的小问题：</p><p><strong>小问题：一个全表扫描会产生有多少次磁盘I/O?</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">between</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">and</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>访问id为1的数据，需要访问当前表空间的第一行数据，一次I/O</li><li>访问id为2的数据，需要访问当前表空间的第二行数据，两次I/O</li><li>访问id为3的数据，需要访问当前表空间的第三行数据，三次I/O......</li></ul><p>我们发现id为1，2，3...的数据都在同一个【数据页】，这会导致一个严重的问题，一次简单的查询，会访问【同一个页很多次】，可能产生很几百次I/O操作。所以为了解决快如闪电的【cpu】，和慢如蜗牛的【磁盘】之间的矛盾，innodb设计了buffer pool，有了缓存之后我们的执行过程如下：</p><ul><li>访问id为1的数据，需要访问当前表空间的第一行数据，缓存当前页，一次I/O</li><li>访问id为2的数据，需要访问当前表空间的第二行数据，从缓存获取，无需I/O</li><li>访问id为3的数据，需要访问当前表空间的第三行数据，从缓存获取，无需I/O......</li></ul><p>Innodb引擎会在mysql启动的时候，向操作系统申请一块连续的空间当做buffer pool，空间的大小由变量<code>innodb_buffer_pool_size</code>确定，我这台电脑他使用了8G，你的可能是128M。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509110739628-49731f16.png" alt="image-20220509110739628" class="img_ev3q">这个缓冲区的大小可以结合自己服务器的性能而定，这就明白了内存大的好处了吧。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一内部结构">一、内部结构<a href="#一内部结构" class="hash-link" aria-label="一、内部结构的直接链接" title="一、内部结构的直接链接">​</a></h3><p>整个buffer pool是由缓冲页和控制块组成的：</p><ul><li><strong>缓冲页：</strong>buffer pool中存放的【数据页】我们称之为【缓冲页】，和磁盘上的数据页是一一对应的，都是16KB，缓冲页的数据，是从磁盘上加载到buffer pool当中的一个完整页。</li><li><strong>控制块：</strong>他是缓冲页【描述信息】，这一块区域保存的是数据页所属的表空间号，数据页编号，数据页地址，以及一些链表相关的节点信息等，每个控制块大小是缓存页的5%左右，大约是800个字节。</li></ul><p>其内部结构如下，buffer pool的前一部分存储【控制块】，后一部分存储【缓冲页】，如果中间有未被利用的空间，就叫他【内存碎片】吧：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509143231600-b665b8b0.png" alt="image-20220509143231600" class="img_ev3q">image-20220509143231600</p><p><strong>tips：buffer pool的初始化</strong></p><p>数据库会在启动的时候，按照配置中的Buffer Pool大小，去向操作系统申请一块内存，作为Buffer Pool的内存区域，然后会按照默认的缓存页的的大小【16KB】以及对应的【800个字节左右】的【控制块】的大小，在Buffer Pool中划分出一个一个的缓存页和一个一个与其对应的描述数据（控制块）。此时的buffer pool像一个干净的本子，没有书写任何内容。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二free链">二、free链<a href="#二free链" class="hash-link" aria-label="二、free链的直接链接" title="二、free链的直接链接">​</a></h3><p>刚初始化的buffer pool，内存中都是【空白的缓冲页】，但是随着时间的推移，程序在执行过程中会不断的有新的页被缓存起来，那怎么来判断哪些缓冲页是【闲置状态】，可以被使用呢，此时就需要【控制块来进行标记和管理】了。innodb在设计之初，会将所有【空闲的缓冲页】所对应的【控制块】作为一个个的节点，形成一个链表，这个链表就是free链，翻译过来就是空闲链表，如下图：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509153220595-930514e2.png" alt="image-20220509153220595" class="img_ev3q">image-20220509153220595</p><p>由上图可知，free链表是一个双向链表，链表上除了控制块以外，还有一个基础节点，存储了free链有多少个描述信息块，也就是有多少个空闲的缓存页，以及指向链表头尾的指针。</p><p>当我们加载数据的时候，会从free链中找到空闲的缓存页，把数据页的【表空间号和数据页】号写入【控制块】。</p><p>加载数据到缓存页后，会把缓存页对应的控制块从free链表中移除。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1怎么知道数据页是否被缓存">1、怎么知道数据页是否被缓存？<a href="#1怎么知道数据页是否被缓存" class="hash-link" aria-label="1、怎么知道数据页是否被缓存？的直接链接" title="1、怎么知道数据页是否被缓存？的直接链接">​</a></h4><p>我们已经有了free链表用来【保存空闲的页】，但是，当下一次访问时，要如何知道当前要访问的页是不是已经被缓存了，最直观的思路就是将buffer poll里的缓存数据【全部遍历一遍】。显然，这要做并不合理，本来设计buffer pool是为了提升效率，如果有人将buffer pool配置的很大，比如32个G，那扫描这一片区域的功夫都可以喝一杯茶了，反而成了累赘。</p><p>事实上，使用【表空间号+页号】就可以确定一个唯一的页，那么我们能不能设计一个hash表，使用【表空间号+页】号当做key，使用【控制块地址】做value，每次查询的时候只需要通过key进行查找即可，大家都知道hash的时间复杂度是O(1)，这样就能迅速定位缓存的页。（和hashmap很像）</p><p>结合我们的free链表，查询/缓存一个页的流程大致如下：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509161002976-2a06e1f4.png" alt="image-20220509161002976" class="img_ev3q">image-20220509161002976</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三flush链表">三、flush链表<a href="#三flush链表" class="hash-link" aria-label="三、flush链表的直接链接" title="三、flush链表的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1脏页">1、脏页<a href="#1脏页" class="hash-link" aria-label="1、脏页的直接链接" title="1、脏页的直接链接">​</a></h4><p>在sql的执行过程中，无论是增删改查，都是优先在buffer pool中进行的，这样可以极大的保证执行效率。但是同样会有一个问题，假如我们对缓存页的某些数据进行了修改（执行了一条update语句），就会导致buffer pool中的缓冲页和磁盘的数据页【数据不一致】，那么此时的缓冲页就称之为【脏页】。当然，这也就说明了，脏页的数据是要刷到磁盘上的。</p><p>我在看极客时间的专栏时，有一位老师的比喻很不错，在古代的酒楼中记账是个技术活，可能经常会有赊账行为。每次记账、赊账都会将相关记录记录在账本之上。但是当饭点高峰期，记账数据巨大，张三仗着自己的岳父是县令大人又来赊账一笔，掌柜一时间太忙没有时间翻阅账本，查看张三的历史记录，所以单独使用一个小黑板，记了一笔张三今天赊账10两银子，一会李四来赊账，再在上面记上一笔。等过了饭点，有时间了，再将记录誊抄至账本，计算张三和李四的总赊账额度，其实就是这么个原理。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2链表结构">2、链表结构<a href="#2链表结构" class="hash-link" aria-label="2、链表结构的直接链接" title="2、链表结构的直接链接">​</a></h4><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509153249620-b602e7fa.png" alt="image-20220509153249620" class="img_ev3q">image-20220509153249620</p><ul><li>flush链表同样是一个双向链表，链表结点是被【修改过的缓存页】的控制块。</li><li>和free链表一样，flush链表也有一个基础结点，链接首尾结点，并存储了有多少个控制块。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3刷盘时机">3、刷盘时机<a href="#3刷盘时机" class="hash-link" aria-label="3、刷盘时机的直接链接" title="3、刷盘时机的直接链接">​</a></h4><p>后台会有专门的线程每隔一段时间就把flush链表中的脏页刷入磁盘中，刷新的速率取决与当前系统是否繁忙。在这样的机制下，万一系统奔溃，是会产生数据不一致的问题的，没有刷入磁盘的数据就会丢失，而mysql通过日志系统解决了这个问题，以后的章节会详细讲解。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四lru链表">四、LRU链表<a href="#四lru链表" class="hash-link" aria-label="四、LRU链表的直接链接" title="四、LRU链表的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1概述">1、概述<a href="#1概述" class="hash-link" aria-label="1、概述的直接链接" title="1、概述的直接链接">​</a></h4><p>内存是有限的，buffer pool更是有限的，缓存只是数据的中转站，当我们的数据量很大以后，buffer pool其实是仅仅能容纳很少一部分数据，所以buffer pool的容量很有可能被使用殆尽，如果此时我们还想继续缓存数据页那该怎么办？</p><p>合理的做法就是，当需要更多的空间缓存【新的数据页】的时候，我们将最近使用最少的【缓冲页淘汰掉】就可以了，这就是典型的LRU（Least Recently Used）算法，我们在讲java的时候也手动实现过基于linkedhashmap的LRU算法。对于innodb而言，则是通过【LRU链表】来完成此功能的，他的结构和上边讲的free链表、flush链表基本相同，只是负责的功能不同而已。</p><p>于是，一个简单的思路诞生了，当客户端访问一条数据时，会加载对应的数据页到buffer pool，并会将缓冲页对应的控制块放置到【LRU链表的首位】。一旦buffer pool被占满，则从链表的末端开始淘汰数据，这是最简单的实现。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2优化">2、优化<a href="#2优化" class="hash-link" aria-label="2、优化的直接链接" title="2、优化的直接链接">​</a></h4><p>但是，实际的在使用场景中，我们需要对原有的LRU链表进行优化，因为他在一下场景可能会出现一些问题：</p><ul><li>数据页预读：我们在讲多线程的时候是讲过【预读性原理】（当一个应用在访问一个数据时，很有可能会继续访问和他相邻的数据），cpu的高级缓冲区读取主存的数据也不是一个字节一个字节的读取，而是一下子会读取一个【缓存行】。同理，innodb从磁盘读取数据，也不一定是一页页读取，当mysql读取当前需要的页时，如果觉得后续操作会使用【附近的页】，就会将他们一起缓存到buffer pool，这样的作用是为了提升效率。但是，这也会导致大量的使用频率并不高的数据放置在LRU链表头部，反而将一些真正的【热点数据】淘汰。</li><li>全表扫描：一条【select * from user】 语句，会直接将一张表的全表数据缓存，并全部放在LRU链表头部，一样会淘汰很多热点数据。</li></ul><p>所以，innodb对该链表进行了优化，将【LRU链表】分成了两个区域，分为【热数据区】和【冷数据区】，默认情况下冷数据区占了总链表的37%，机构如下：</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509180031426-501d93db.png" alt="image-20220509180031426" class="img_ev3q">image-20220509180031426</p><p><strong>tips：</strong>一个select语句可能会多次访问一个页，因为你有【很多数据是保存在同一个页内】的。对于一个全表扫描的语句，每访问一条数据，就会访问一次相关的页，所以缓存确实能极大的提升效率：</p><ul><li><p>对于预读的数据页，会在第一次访问时放入old区域，如果在sql执行的过程中访问相邻数据时，再次访问访问到该数据页，则把他加入如热数据区。</p></li><li><p>【大表的全表扫描】是个使用频率很低的操作（小表怎么操作都无所谓），但是如果按照上边的操作，首先全表数据会被放在【old区】，全表扫描必然会因为访问相邻数据而产生第二次、第三次、甚至数百次的访问，也就以为着这些页面会被全部放在young区。为了解决这个问题，INnodb提供了这样一个参数【innodb_old_blocks_time】，默认是1s，他的执行流程大致如下：</p><p>  1、页被首次访问时会记录访问的时间戳。</p><p>  2、以后访问都和首次访问的时间进行对比，如果时间大于1s，就讲当前页放入yong区。</p><p>  3、一个sql的扫描一个页的时间，哪怕在慢也不会低于1s，这样就解决了一个全表扫秒而导致全表成为热点数据的问题。</p></li></ul><p>tips：也就意味着，热点数据要求首次访问时间和最后一次访问时间的时间差不能低于1s。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220509180909014-c5327db9.png" alt="image-20220509180909014" class="img_ev3q">image-20220509180909014</p><p>tips：使用以下的语句，可以查看innodb当前的状态：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">show engine innodb status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">Total large memory allocated </span><span class="token number" style="color:rgb(247, 140, 108)">8585216</span><span class="token plain">                  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic"># 为innodb 分配的总内存数(byte)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Dictionary memory allocated </span><span class="token number" style="color:rgb(247, 140, 108)">446370</span><span class="token plain">                    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#为innodb数据字典分配的内存数(byte)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Buffer pool size   </span><span class="token number" style="color:rgb(247, 140, 108)">512</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#innodb_buffer_pool的大小(page)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Free buffers       </span><span class="token number" style="color:rgb(247, 140, 108)">101</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#innodb_buffer_pool lru列表中的空闲页面数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Database pages     </span><span class="token number" style="color:rgb(247, 140, 108)">277</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#innodb_buffer_pool lru列表中的非空闲页面数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Old database pages </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">                                  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#innodb_buffer_pool old子列表的页面数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Modified db pages  </span><span class="token number" style="color:rgb(247, 140, 108)">273</span><span class="token plain">                                </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#innodb_buffer_pool 中脏页的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Pending reads      </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">                                  </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#挂起读的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Pending writes: LRU </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">, flush list </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">, single page </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">#挂起写的数量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Pages made young </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">, not young </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain"> youngs/s, </span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain"> non-youngs/s</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Pages </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">read</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8002054</span><span class="token plain">, created </span><span class="token number" style="color:rgb(247, 140, 108)">766955</span><span class="token plain">, written </span><span class="token number" style="color:rgb(247, 140, 108)">4652116</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain"> reads/s, </span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain"> creates/s, </span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain"> writes/s</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Buffer pool hit rate </span><span class="token number" style="color:rgb(247, 140, 108)">993</span><span class="token plain"> / </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain">, young-making rate </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> / </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain"> not </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> / </span><span class="token number" style="color:rgb(247, 140, 108)">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">Pages </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">read</span><span class="token plain"> ahead </span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain">/s, evicted without access </span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain">/s, Random </span><span class="token builtin class-name" style="color:rgb(255, 203, 139)">read</span><span class="token plain"> ahead </span><span class="token number" style="color:rgb(247, 140, 108)">0.00</span><span class="token plain">/s</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">LRU len: </span><span class="token number" style="color:rgb(247, 140, 108)">277</span><span class="token plain">, unzip_LRU len: </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">I/O sum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">22009</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">:cur</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">1940</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">, </span><span class="token function" style="color:rgb(130, 170, 255)">unzip</span><span class="token plain"> sum</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">:cur</span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第四章-mysql临时表">第四章 MySQL临时表<a href="#第四章-mysql临时表" class="hash-link" aria-label="第四章 MySQL临时表的直接链接" title="第四章 MySQL临时表的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一临时表简介">一、临时表简介<a href="#一临时表简介" class="hash-link" aria-label="一、临时表简介的直接链接" title="一、临时表简介的直接链接">​</a></h3><p>MySQL临时表在很多场景中都会用到，比如用户自己创建的临时表用于【保存临时数据】，以及MySQL内部在执行【复杂SQL】时，需要借助临时表进行【分组、排序、去重】等操作，临时表具有一下几个特点：</p><p>1）临时表不能通过<code>show tables</code>查看，在服务器重启之后，所有的临时表将全部被销毁。</p><p>2）临时表是每个进程独享的，当前进程（客户端）创建的临时表，其他进程（客户端）是查不到临时表里面的数据的，所以不同客户端可以创建同名的临时表。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二临时表分类">二、临时表分类<a href="#二临时表分类" class="hash-link" aria-label="二、临时表分类的直接链接" title="二、临时表分类的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1外部临时表">1、外部临时表<a href="#1外部临时表" class="hash-link" aria-label="1、外部临时表的直接链接" title="1、外部临时表的直接链接">​</a></h4><p>通过create temporary table语句创建的临时表为外部临时表，创建语句如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">temporary</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">table</span><span class="token plain"> temp_table</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    id </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name </span><span class="token keyword" style="color:rgb(127, 219, 202)">varchar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">InnoDB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> temp_table </span><span class="token keyword" style="color:rgb(127, 219, 202)">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;1&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> temp_table </span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 删除临时表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">TEMPORARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">TABLE</span><span class="token plain"> table_name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2内部临时表">2、内部临时表<a href="#2内部临时表" class="hash-link" aria-label="2、内部临时表的直接链接" title="2、内部临时表的直接链接">​</a></h4><p>【内部临时表】用来存储某些操作的【中间结果】，这些操作可能包括在【优化阶段】或者【执行阶段】，这种内部表对用户来说是不可见的。通常在执行复杂SQL语句时，比如group by，distinct，union等语句时，MySQL内部将使用【自动生成的临时表】，以辅助SQL的执行。我们可以使用执行计划查看，如果一条sql语句的执行计划中【列extra】结果为Using temporary，那么也就说明这个查询要使用到临时表。执行计划，我们后边会详细讲解。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220512171531287-af1986a5.png" alt="image-20220512171531287" class="img_ev3q">image-20220512171531287</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3group-by执行流程">3、group by执行流程<a href="#3group-by执行流程" class="hash-link" aria-label="3、group by执行流程的直接链接" title="3、group by执行流程的直接链接">​</a></h4><p>这个例子中我们使用，课程【mysql入门】中的一张学生表，执行以下sql，统计各个年龄的人数，并按照年龄大学排序：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token function" style="color:rgb(130, 170, 255)">count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> student </span><span class="token keyword" style="color:rgb(127, 219, 202)">group</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">by</span><span class="token plain"> age </span><span class="token keyword" style="color:rgb(127, 219, 202)">order</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">by</span><span class="token plain"> age</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>他的执行流程如下：</strong></p><p>（1）创建一个内部临时表，有两列，一列是age，一列是count(*)。</p><p>（2）全表扫描【原始表】（聚簇索引会在后边的内容讲解），每扫描一条数据进行一次判断，第一种情况，这条数据的年龄在临时表中不存在，则将年龄填入，count列填1。第二种情况，该条数据在临时表中存在，则将count列加1。临时表的存在是为了辅助计算。</p><p>（3）对临时表的数据按照年龄进行排序。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220512173136197-67e95f7b.png" alt="image-20220512173136197" class="img_ev3q">image-20220512173136197</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4内部临时表创建时机">4、内部临时表创建时机<a href="#4内部临时表创建时机" class="hash-link" aria-label="4、内部临时表创建时机的直接链接" title="4、内部临时表创建时机的直接链接">​</a></h4><p><strong>MySQL在以下几种情况会创建临时表，大家也要思考为什么会产生临时表：</strong></p><p>1、使用GROUP BY分组，且分组字段没有索引时。</p><p>2、使用DISTINCT查询。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220512180936503-7bb9f8be.png" alt="image-20220512180936503" class="img_ev3q">image-20220512180936503</p><p>3、使用UNION进行结果合并，辅助去重。</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220512181256543-8c827827.png" alt="image-20220512181256543" class="img_ev3q">image-20220512181256543</p><p>注意：【union all】不会使用零时表，因为他不需要去重</p><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220512181433029-019f7ad6.png" alt="image-20220512181433029" class="img_ev3q">image-20220512181433029</p><p>复杂的sql中很容易产生临时表，这需要大家在工作中不断的学习和积累。</p><p><strong>tips：</strong>其实临时表还可以分为【内存临时表】和【磁盘临时表】。内存临时表使用memery引擎（Memory引擎不支持BOLB和TEXT类型），磁盘临时表默认使用innodb引擎。在以下几种情况下，会创建磁盘临时表：</p><p>1、数据表中包含BLOB/TEXT列；</p><p>2、在 GROUP BY 或者 DSTINCT 的列中有超过 512字符的字符类型列；</p><p>3、在SELECT、UNION、UNION ALL查询中，存在最大长度超过512的列（对于字符串类型是512个字符，对于二进制类型则是512字节）；</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="第五章-mysql事务">第五章 MySQL事务<a href="#第五章-mysql事务" class="hash-link" aria-label="第五章 MySQL事务的直接链接" title="第五章 MySQL事务的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一事务简介">一、事务简介<a href="#一事务简介" class="hash-link" aria-label="一、事务简介的直接链接" title="一、事务简介的直接链接">​</a></h3><p>首先给大家举一个例子：我们有如下的销售业务，一个销售业务可能包含很多步骤，比如记录订单、添加积分、管理库存、扣减金额等等，每一个操作都可能对应一条或多条sql语句，但是这个业务却是不可分割的，不能下了订单，不扣减库存。此时我们就需要事务来统一管理这个业务当中的一系列sql语句了。</p><p>（1）在 MySQL 中只有使用了 Innodb 数据库引擎的数据库或表才支持事务。</p><p>（2）事务处理可以用来维护数据库的完整性，保证成批的 SQL 语句要么全部执行，要么全部不执行。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二事务分类">二、事务分类<a href="#二事务分类" class="hash-link" aria-label="二、事务分类的直接链接" title="二、事务分类的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1显式事务和隐式事务">1、显式事务和隐式事务<a href="#1显式事务和隐式事务" class="hash-link" aria-label="1、显式事务和隐式事务的直接链接" title="1、显式事务和隐式事务的直接链接">​</a></h4><p>（1）mysql的事务可以分为【显式事务】和【隐式事务】。默认的事务是隐式事务，由变量【autocommit】控制。隐式事务的环境下，我们每执行一条sql都会【自动开启和关闭】事务，变量如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">SHOW VARIABLES LIKE &#x27;autocommit&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://www.ydlclass.com/doc21xnv/assets/image-20220512184029517-66be300a.png" alt="image-20220512184029517" class="img_ev3q">image-20220512184029517</p><p>（2）显式事务由我们【自己控制】事务的【开启，提交，回滚】等操作，我们创建一个表，同时展示事务的基础语法，如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">database</span><span class="token plain"> ydlTrx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">use</span><span class="token plain"> ydlTrx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- UNSIGNED代表无符号数，不能是负数 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">create</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">table</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    id </span><span class="token keyword" style="color:rgb(127, 219, 202)">int</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">primary</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">key</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">auto_increment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    name </span><span class="token keyword" style="color:rgb(127, 219, 202)">VARCHAR</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    balance </span><span class="token keyword" style="color:rgb(127, 219, 202)">DECIMAL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">UNSIGNED</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">VALUES</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥老婆&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">50000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 转账业务，必须都成功，或者都失败，所以不能一句一句执行，万一执行了一半，断电了咋办</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 所以要编程一个整体</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 都成功</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 开启事务;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 提交事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 都失败</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 回滚事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">rollback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们可以使用begin或start transaction开启一个事务，使用commit提交事务，使用rollback回滚当前事务。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2只读事务和读写事务">2、只读事务和读写事务<a href="#2只读事务和读写事务" class="hash-link" aria-label="2、只读事务和读写事务的直接链接" title="2、只读事务和读写事务的直接链接">​</a></h4><p>我们可以使用read only开启只读事务，开启只读事务模式之后，事务执行期间任何【insert】或者【update】语句都是不允许的，具体语法如下：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> only</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有人可能会问，这样和不开事务有什么区别呢？这个在下边学了隔离级别就知道了。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3保存点">3、保存点<a href="#3保存点" class="hash-link" aria-label="3、保存点的直接链接" title="3、保存点的直接链接">​</a></h4><p>我们可以使用savepoint 关键字在事务执行中新建【保存点】，之后可以使用rollback向任意保存点回滚。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">savepoint</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">rollback</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">to</span><span class="token plain"> a</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>注意：</strong>Mysql是不支持嵌套事务的，开启一个事务的情况下，若再开启一个事务，会隐式的提交上一个事务：</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 这里会自动将第一个事务提交</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">200</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">    </span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 回滚事务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">rollback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="三事务四大特征acid">三、事务四大特征（ACID）<a href="#三事务四大特征acid" class="hash-link" aria-label="三、事务四大特征（ACID）的直接链接" title="三、事务四大特征（ACID）的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1原子性atomicity">1、原子性（Atomicity）<a href="#1原子性atomicity" class="hash-link" aria-label="1、原子性（Atomicity）的直接链接" title="1、原子性（Atomicity）的直接链接">​</a></h4><p>一个事务（transaction）中的所有操作，<strong>要么全部完成，要么全部不完成</strong>，不会结束在中间某个环节。如果事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样，这个很好理解。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2一致性consistency">2、一致性（Consistency）<a href="#2一致性consistency" class="hash-link" aria-label="2、一致性（Consistency）的直接链接" title="2、一致性（Consistency）的直接链接">​</a></h4><p>在事务【开始之前和结束以后】，数据库的完整性没有被破坏，数据库状态应该与业务规则保持一致。<strong>举一个例子</strong>：A向B转账，不可能A扣了钱，B却没有收到，也不可能A和B的总金额，在事务前后发生变化，产生数据不一致。其他的三个特性都在为他服务。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3隔离性isolation">3、隔离性（Isolation）<a href="#3隔离性isolation" class="hash-link" aria-label="3、隔离性（Isolation）的直接链接" title="3、隔离性（Isolation）的直接链接">​</a></h4><p>数据库【允许多个并发事务同时对其数据进行读取和修改】，隔离性可以防止多个事务在并发修改共享数据时产生【数据不一致】的现象，这里要联想到我们学习过的多线程。</p><p>事务隔离级别分为不同等级，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable），后续会详细讲。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4持久性durability">4、持久性（Durability）<a href="#4持久性durability" class="hash-link" aria-label="4、持久性（Durability）的直接链接" title="4、持久性（Durability）的直接链接">​</a></h4><p>事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="四事务隔离级别">四、事务隔离级别<a href="#四事务隔离级别" class="hash-link" aria-label="四、事务隔离级别的直接链接" title="四、事务隔离级别的直接链接">​</a></h3><p>对于数据库的四大特性中的【隔离级别】是比较难理解的，我们在本小结中详细介绍。</p><p>在多个事务【并发操作】相同的表数据时，为了让多个事务都可以得到正确的结果，不会因为互相的交叉操作产生干扰，同时还要保证一定的执行效率，故而提出了不同的隔离级别。</p><p><strong>隔离级别分类如下，在不同的隔离级别下可能产生不同的问题，如脏读、不可重复度、幻读等，我们会在后边的课程中一一讲解：</strong></p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>解决方案</th></tr></thead><tbody><tr><td>Read uncommitted（读未提交）</td><td>√</td><td>√</td><td>√</td><td></td></tr><tr><td>Read committed（读已提交）</td><td>×</td><td>√</td><td>√</td><td>undo log</td></tr><tr><td>Repeatable read（可重复读）</td><td>×</td><td>×</td><td>√</td><td>MVCC版本控制+间隙锁（mysql的rr不存在幻读）</td></tr><tr><td>Serializable（串行化）</td><td>×</td><td>×</td><td>×</td><td></td></tr></tbody></table><p>注意：传统意义上的rr级别是存在幻读问题的，但是mysql的rr级别不存在。</p><p><strong>在mysql中查看和设置【事务的隔离级别】，语法如下：</strong></p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 查看全局和当前事务的隔离级别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SELECT</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@global.transaction_isolation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> @</span><span class="token variable" style="color:rgb(214, 222, 235)">@transaction_isolation_isolation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">show</span><span class="token plain"> variables </span><span class="token operator" style="color:rgb(127, 219, 202)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;transaction_isolation&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">--5.7   tx_isolation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">--8.0   transaction_isolation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 设置下一个事务的隔离级别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">uncommitted</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">committed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">repeatable</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">serializable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 设置当前会话的隔离级别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">uncommitted</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">committed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">repeatable</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">serializable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 设置全局事务的隔离级别</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">uncommitted</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">committed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">repeatable</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">serializable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">其中，</span><span class="token keyword" style="color:rgb(127, 219, 202)">SESSION</span><span class="token plain"> 和 </span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain"> 关键字用来指定修改的事务隔离级别的范围：</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SESSION</span><span class="token plain">：表示修改的事务隔离级别将应用于当前 </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain">（当前 cmd 窗口）内的所有事务；</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain">：表示修改的事务隔离级别将应用于所有 </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain">（全局）中的所有事务，且当前已经存在的 </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> 不受影响；</span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain">如果省略 </span><span class="token keyword" style="color:rgb(127, 219, 202)">SESSION</span><span class="token plain"> 和 </span><span class="token keyword" style="color:rgb(127, 219, 202)">GLOBAL</span><span class="token plain">，表示修改的事务隔离级别将应用于当前 </span><span class="token keyword" style="color:rgb(127, 219, 202)">session</span><span class="token plain"> 内的下一个还未开始的事务。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1读未提交ru">1、读未提交（RU）<a href="#1读未提交ru" class="hash-link" aria-label="1、读未提交（RU）的直接链接" title="1、读未提交（RU）的直接链接">​</a></h4><p>【ru隔离级别】说的简单一点就是，一个事务可以读取其他【未提交的事务】修改的数据，这种隔离级别最低，一般情况下，数据库隔离级别都要高于该级别，该隔离级别下，可能会存在脏读、不可重复度，幻读的问题。</p><p><strong>脏读：</strong>指的是一个事务读到了其他事务未提交的数据，未提交意味着这些数据可能会回滚，读到的数据不一定准确。</p><p><strong>案例：</strong></p><p>楠哥发工资了，老婆让楠哥把工资打到他老婆的账号上，但是该事务并未提交，就让老婆去查看，老婆一看真的打了钱了，高高兴兴关了网页，此时楠哥急中生智进行回滚，钱瞬间回来，一次蒙混了一个月工资。所以楠哥老婆看到的数据我们称之为“脏数据”。</p><p>第一步：使用两个窗口，开启两个事务，且将隔离级别设置为RU。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">use</span><span class="token plain"> ydlTrx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">uncommitted</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：楠哥，给转账老婆转账10000元，但是不提交。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三部步：楠哥通知老婆进行查账，确实读取到了楠哥未提交事务修改的数据。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第四步：老婆查账结束，楠哥来一个回马枪，对自己的事务进行回滚操作。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">rollback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第五步：楠哥老婆某天查账，突然发现，哎，怎么少了一万。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2读已提交rc">2、读已提交（RC）<a href="#2读已提交rc" class="hash-link" aria-label="2、读已提交（RC）的直接链接" title="2、读已提交（RC）的直接链接">​</a></h4><p>【RC读已提交】说的是当前事务只能读到别的事物已经提交的数据，该隔离级别可能会产生不可重复读和幻读。</p><p>【不可重复读】的官方解释是：【一个事务】（A事务）修改了【另一个未提交事务】（B事务）读取过的数据。那么B事务【再次读取】，会发现两次读取的数据不一致。也就是说在一个原子性的操作中一个事务两次读取相同的数据，却不一致，一行数据不能重复被读取。主要是【update】语句，会导致不可重复读。</p><p><strong>案例：</strong></p><p>楠哥拿着工资卡去消费，系统读取到卡里确实有10200元，而此时她的老婆也正好在网上转账，把楠哥工资卡的2000元转到另一账户，并在 楠哥之前提交了事务，当楠哥扣款时，系统检查到楠哥的工资卡和上次读取的不一样了，楠哥十分纳闷，明明卡里有钱，为何......</p><p>第一步：将事务的隔离级别设置为RC。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">committed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：楠哥准备去消费了，检查存款显示有余额，贼高兴。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三步：楠哥老婆在楠哥没有提交事务的时候，进行了一笔转账，并且提交了事务。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">500</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">500</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第四步：楠哥再次查账，同一个事务里，发现钱少了。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>当隔离级别设置为Read committed 时，避免了脏读，但是可能会造成不可重复读。</p><p>大多数数据库的默认级别就是Read committed，比如Sql Server , Oracle。如何解决不可重复读这一问题，请看下一个隔离级别。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3可重复读rr">3、可重复读（RR）<a href="#3可重复读rr" class="hash-link" aria-label="3、可重复读（RR）的直接链接" title="3、可重复读（RR）的直接链接">​</a></h4><p>学习完不可重复读，理解【可重复读】就简单多了，他的意思是，同一个事务中发出同一个SELECT语句【两次或更多次】，那么产生的结果数据集总是相同的，在RR隔离级别中可能出现幻读。</p><p><strong>幻读：</strong>一个事务按照某些条件进行查询，事务提交前，有另一个事务插入了满足条件的其他数据，再次使用相同条件查询，却发现多了一些数据，就像出现了幻觉一样。幻读主要针对针对delete和insert语句。</p><p>不可重复读强调的是两次读取的数据【内容不同】，幻读前调的是两次读取的【行数不同】。</p><p><strong>案例</strong></p><p>楠哥的老婆在银行部门工作，她时常通过银行内部系统查看楠哥的账户信息。有一天，她正在查询到楠哥账户信息时发现楠哥只有一个账户，心想这家伙应该没有私房钱。此时楠哥在另外一家分行又开了一个账户，准备存私房钱。同时，楠哥老婆在同一个事务中又一次查询，结果显示出的楠哥账户居然多了一个，真实奇怪。</p><p>第一步：将数据库的隔离级别设置为RR。</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">set  transaction isolation level repeatable read;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：楠哥开启事务。</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token plain">start transaction;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三步：老婆查账户。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第四步：楠哥趁机开户，并提交事务。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第五步：老婆再查询并打印，应该发现楠哥多了一个账户，但是没有，并没有出现幻读。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>注意：</strong>在mysql中的RR隔离级别中，innodb使用mvcc+锁帮我们解决了绝大部分的幻读情况，</p><p>上边的例子稍微修改一下，我们就能看到幻读现象了。</p><p>第一步：将数据库的隔离级别设置为RR。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">repeatable</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">read</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：楠哥开启事务。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三步：老婆查账户。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">start</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第四步：楠哥趁机开户，并提交事务。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">insert</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">into</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token number" style="color:rgb(247, 140, 108)">10000</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第五步：老婆好心给所有的账户充值100，再查询并打印，结果发现楠哥多了一个账户，出现幻读。</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token comment" style="color:rgb(99, 119, 119);font-style:italic">-- 先给所有的账户钱充值一百</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">UPDATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">set</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> balance </span><span class="token operator" style="color:rgb(127, 219, 202)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">100</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(173, 219, 103)">&#x27;楠哥&#x27;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里边的原理过于复杂，目前我们先卖个关子，等我们学完【锁和mvcc】以后回来在看，就能明白了。</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4串行化">4、串行化<a href="#4串行化" class="hash-link" aria-label="4、串行化的直接链接" title="4、串行化的直接链接">​</a></h4><ul><li>事务A和事务B，事务A在操作数据库时，事务B只能排队等待</li><li>这种隔离级别很少使用，吞吐量太低，用户体验差</li><li>这种级别可以避免“幻读”，每一次读取的都是数据库中真实存在数据，事务A与事务B串行，而不并发。</li></ul><p>第一步：修改数据库的隔离级别</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">SET</span><span class="token plain">  </span><span class="token keyword" style="color:rgb(127, 219, 202)">transaction</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">isolation</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">level</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">serializable</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一步：楠哥执行查询操作</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">begin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第二步：楠哥老婆执行查询操作</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">begin</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#d6deeb"><span class="token plain"></span><span class="token keyword" style="color:rgb(127, 219, 202)">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(127, 219, 202)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第三部：楠哥老婆想执行一个删除操作，发现事务被阻塞了，需要等待</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">delete</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">from</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">user</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(127, 219, 202)">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(127, 219, 202)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第四部：楠哥这边一提交，老婆那边就能操作了</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#d6deeb;--prism-background-color:#011627"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#d6deeb"><span class="token keyword" style="color:rgb(127, 219, 202)">commit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Java/3.mysql学习/2.mysql进阶-上.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Java/mysql学习/mysql入门"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">mysql入门</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Java/mysql学习/mysql进阶-下"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">mysql进阶-下</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#第一章-mysql架构" class="table-of-contents__link toc-highlight">第一章 mysql架构</a><ul><li><a href="#一mysql的系统架构" class="table-of-contents__link toc-highlight">一、mysql的系统架构</a></li><li><a href="#二目录结构" class="table-of-contents__link toc-highlight">二、目录结构</a></li><li><a href="#三字符集和排序规则" class="table-of-contents__link toc-highlight">三、字符集和排序规则</a></li><li><a href="#四mysql修改配置的方法" class="table-of-contents__link toc-highlight">四、mysql修改配置的方法</a></li><li><a href="#五内置数据库" class="table-of-contents__link toc-highlight">五、内置数据库</a></li></ul></li><li><a href="#第二章-io和存储" class="table-of-contents__link toc-highlight">第二章 I/O和存储</a><ul><li><a href="#一io成本" class="table-of-contents__link toc-highlight">一、IO成本</a></li><li><a href="#二数据存储" class="table-of-contents__link toc-highlight">二、数据存储</a></li></ul></li><li><a href="#第三章-缓冲池-buffer-pool" class="table-of-contents__link toc-highlight">第三章 缓冲池 buffer pool</a><ul><li><a href="#一内部结构" class="table-of-contents__link toc-highlight">一、内部结构</a></li><li><a href="#二free链" class="table-of-contents__link toc-highlight">二、free链</a></li><li><a href="#三flush链表" class="table-of-contents__link toc-highlight">三、flush链表</a></li><li><a href="#四lru链表" class="table-of-contents__link toc-highlight">四、LRU链表</a></li></ul></li><li><a href="#第四章-mysql临时表" class="table-of-contents__link toc-highlight">第四章 MySQL临时表</a><ul><li><a href="#一临时表简介" class="table-of-contents__link toc-highlight">一、临时表简介</a></li><li><a href="#二临时表分类" class="table-of-contents__link toc-highlight">二、临时表分类</a></li></ul></li><li><a href="#第五章-mysql事务" class="table-of-contents__link toc-highlight">第五章 MySQL事务</a><ul><li><a href="#一事务简介" class="table-of-contents__link toc-highlight">一、事务简介</a></li><li><a href="#二事务分类" class="table-of-contents__link toc-highlight">二、事务分类</a></li><li><a href="#三事务四大特征acid" class="table-of-contents__link toc-highlight">三、事务四大特征（ACID）</a></li><li><a href="#四事务隔离级别" class="table-of-contents__link toc-highlight">四、事务隔离级别</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.730de416.js"></script>
<script src="/assets/js/main.887d1c07.js"></script>
</body>
</html>